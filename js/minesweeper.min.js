(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var D=window.SweeperOSEnvironment;var K=null;var T=0;var q=true;var C=true;var H=true;var g=false;var ab=false;var p=0;var c=0;var M=0;var u=0;var G=0;var R=null;var ao=0;var N=false;var k=false;var U=true;var w=false;var A=true;var at=false;var aB=9;var Y=9;var av=10;var h=true;var r=false;var x=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function am(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(aD){$(".smiley-icon").removeClass("active");N=false;k=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(aD){if($(".window#ms-main").hasClass("focused")){if(aD.which==113){aD.preventDefault();J(M)}else{if(aD.which==112){aD.preventDefault();L()}else{if(aD.which==27){if(r){q=false}}}}return}if($(".window#ms-custom-board").hasClass("focused")){if(aD.which==27){ak()}else{if(aD.which==13){if($(".cst-form input").is(":focus")){z()}else{$("#ms-custom-board .btns .btn-container.active").click()}}}return}if($(".window#ms-high-score").hasClass("focused")){if(aD.which==27||aD.which==13){y()}return}if($(".window#ms-leaderboard").hasClass("focused")){if(aD.which==27){W()}else{if(aD.which==13){$(this).find("#ms-leaderboard .btns .btn-container.active").click()}}return}if($(".window#ms-about").hasClass("focused")){if(aD.which==27||aD.which==13){Q()}return}if($(".window#ms-help").hasClass("focused")){if(aD.which==27||aD.which==13){B()}return}});$(".minesweeper").off("mousedown").on("mousedown",function(aD){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g&&(aD.which==1||aD.which==2)){$(".smiley-icon").addClass("active")}if(aD.which==2){r=true}});$(".minesweeper").off("mouseup").on("mouseup",function(aD){r=false});$(".smiley-btn").off("click").on("click",function(aD){J(M)});$("#game_new").on("click",function(aD){J(M)});$("#game_beg:not(.disabled)").on("click",function(aD){az(0)});$("#game_int:not(.disabled)").on("click",function(aD){az(1)});$("#game_exp:not(.disabled)").on("click",function(aD){az(2)});$("#game_cst:not(.disabled)").on("click",function(aE){var aD=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(Y);$("#ms-custom-board #cst-width").val(aB);$("#ms-custom-board #cst-mines").val(av);D.showWindow($("#ms-custom-board"),aD.left,aD.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(aD){s(!U)});$("#game_snd:not(.disabled)").on("click",function(aD){aw(!w)});$("#game_clr:not(.disabled)").on("click",function(aD){d(!A)});$("#game_ldr:not(.disabled)").on("click",function(aD){aa()});$("#help_abt:not(.disabled)").on("click",function(aD){ad()});$("#help_play:not(.disabled)").on("click",function(aD){L()});$("#cst_ok").on("click",z);$("#cst_cancel").on("click",ak);$("#hs_ok").on("click",y);$("#leader_ok").on("click",W);$("#leader_reset").on("click",P);$("#about_ok").on("click",Q);$("#help_ok").on("click",B);J(0)});function z(){var aF=$("#cst-width").val();var aE=$("#cst-height").val();var aD=$("#cst-mines").val();f(aF,aE,aD);az(3);D.closeWindow($("#ms-custom-board"))}function ak(){J(M);D.closeWindow($("#ms-custom-board"))}function y(){al(M,$("#ms-high-score #hs-name").val(),T);D.closeWindow($("#ms-high-score"));aa()}function W(){D.closeWindow($("#ms-leaderboard"))}function aa(){var aE=$(".minesweeper").offset();var aD=$(".ms-status").offset().top+$(".ms-status").outerHeight();D.showWindow($("#ms-leaderboard"),aE.left,aD,$("#ms-main"))}function ad(){var aD=$(".minesweeper").offset();D.showWindow($("#ms-about"),aD.left+30,aD.top+33,$("#ms-main"))}function Q(){D.closeWindow($("#ms-about"))}function L(){var aD=$(".minesweeper").offset();D.showWindow($("#ms-help"),aD.left+30,aD.top+33,$("#ms-main"))}function B(){$("#ms-help .help-content-inner").scrollTop(0);D.closeWindow($("#ms-help"))}function aw(aD,aE){if(aD==true){w=true;$("#game_snd").addClass("checked")}else{w=false;$("#game_snd").removeClass("checked")}if(!aE){l("snd",w)}}function s(aD,aE){if(aD==true){U=true;$("#game_mrk").addClass("checked")}else{U=false;$("#game_mrk").removeClass("checked")}if(!aE){l("mrk",U)}}function d(aD,aE){if(aD==true){A=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{A=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!aE){l("clr",A)}}function az(aH,aG){if(aH<0||aH>3){return}if(aH!=3){aB=9;Y=9;av=10;at=false}var aD=["beg","int","exp","cst"];for(var aF=0;aF<aD.length;aF++){var aE=$("#game_"+aD[aF]);if(aF==aH){aE.addClass("checked")}else{aE.removeClass("checked")}}if(!aG){l("lvl",aH)}J(aH)}function f(aG,aD,aH,aF){if(!/^\d*$/.test(aG)){aG=9}aG=(aG>30?30:aG);aG=(aG<9?9:aG);if(!/^\d*$/.test(aD)){aD=9}aD=(aD>24?24:aD);aD=(aD<9?9:aD);if(!/^\d*$/.test(aH)){aH=10}aH=(aH<10?10:aH);var aE=(aD-1)*(aG-1);aH=(aH>aE?aE:aH);at=true;aB=aG;Y=aD;av=aH;if(!aF){l("board_width",aG);l("board_height",aD);l("board_mines",aH)}}function ay(){$(".window *").off("contextmenu").on("contextmenu",function(aD){aD.preventDefault()});$(".minesweeper .ms-panel").off("mousedown").on("mousedown",function(aE){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g){switch(aE.which){case 1:N=true;$(this).trigger("mouseenter");break;case 2:k=true;$(this).trigger("mouseenter");break;case 3:var aD=$(this);b(aD,aE);break}}});$(".minesweeper .ms-panel").off("mouseenter").on("mouseenter",function(aH){if(N&&!$(this).hasClass("flagged")){$(this).addClass("down")}else{if(k){var aG=ae($(this));var aF=j(aG[0],aG[1]);for(var aE=aF[0][0];aE<=aF[0][1];aE++){for(var aD=aF[1][0];aD<=aF[1][1];aD++){if(!O(aE,aD)){$('.ms-panel[data-coord="'+aE+","+aD+'"]').addClass("down")}}}}}});$(".minesweeper .ms-panel").off("mouseleave").on("mouseleave",function(aD){if((N||k)&&(aD.which==1||aD.which==2)){$(".ms-panel.down").removeClass("down")}});$(".minesweeper .ms-panel").off("mouseup").on("mouseup",function(aE){if((N||k)&&!g){if(C){o()}var aD=$(this);b(aD,aE)}})}function b(aM,aN){if(!aM.length||!aM.hasClass("ms-panel")){return}var aK=ae(aM);var aP=aK[0];var aE=aK[1];if(aN.which==1){$(".smiley-icon").removeClass("active");N=false;if(!g){if(!aq(aP,aE)){ai(aP,aE)}}}if(aN.which==2&&I(aP,aE)&&aq(aP,aE)){var aD=j(aP,aE);var aF=[];var aL=Z(aP,aE);for(var aI=aD[0][0];aI<=aD[0][1];aI++){for(var aH=aD[1][0];aH<=aD[1][1];aH++){if(aI==aP&&aH==aE){continue}if(O(aI,aH)){aL--}else{aF.push([aI,aH])}}}if(aL!==0){return}var aG=aF.length;for(var aI=0;aI<aG;aI++){var aJ=aF[aI][0];var aO=aF[aI][1];if(e(aJ,aO)){aF.splice(aI,1);aF.push([aJ,aO]);aG--;aI--}}for(var aI=0;aI<aF.length;aI++){var aJ=aF[aI][0];var aO=aF[aI][1];ai(aJ,aO)}}else{if(aN.which==3){if(!g&&!aq(aP,aE)){if(!O(aP,aE)&&!ax(aP,aE)){aC(aP,aE);V()}else{if(U&&O(aP,aE)){ah(aP,aE);aj()}else{if(!U){aj()}ac(aP,aE)}}}}}}function ae(aE){var aD=aE.data("coord").split(",");return[parseInt(aD[0],10),parseInt(aD[1],10)]}function aC(aF,aD){var aE=R[aF][aD];if(!g&&!aE.triggered&&!aE.marked){R[aF][aD].flagged=true}af(aF,aD)}function ah(aF,aD){var aE=R[aF][aD];if(!g&&!aE.triggered&&aE.flagged){aE.flagged=false;aE.marked=true}R[aF][aD]=aE;af(aF,aD)}function ac(aF,aD){var aE=R[aF][aD];if(!g&&!aE.triggered){aE.marked=false;aE.flagged=false}R[aF][aD]=aE;af(aF,aD)}function ai(aF,aD){var aE=R[aF][aD];if(g||aE.triggered||aE.flagged){return}aE.triggered=true;R[aF][aD]=aE;if(!H&&aE.isMine){m(aF,aD);return}else{if(H&&aE.isMine){R[aF][aD].isMine=false;E(aF,aD,true);F(aF,aD)}}af(aF,aD);if(aE.number==0&&!aE.isMine&&!aE.flagged){aA(aF,aD)}if(--ao==0){a()}H=false}function aA(aL,aE){var aD=(aL==0)?0:aL-1;var aK=(aL==G-1)?G-1:aL+1;var aI=(aE==0)?0:aE-1;var aF=(aE==u-1)?u-1:aE+1;for(var aH=aD;aH<=aK;aH++){for(var aG=aI;aG<=aF;aG++){var aJ=R[aH][aG];if(aJ.number>0||(!aJ.isMine&&!aJ.flagged)){ai(aH,aG)}}}}function n(aE,aD){R[aE][aD].isMine=true}function m(aE,aD){var aG=R[aE][aD];if(!aG.isMine){return}aG.exploded=true;R[aE][aD]=aG;if(w){document.getElementById("snd_explode").play()}an();for(var aE=0;aE<G;aE++){for(var aD=0;aD<u;aD++){var aF=R[aE][aD];var aH=false;if(!aF.flagged&&aF.isMine){aH=true}else{if(!aF.isMine&&aF.flagged){aH=true;aF.number=0}}if(aH){aF.triggered=true;R[aE][aD]=aF;af(aE,aD)}}}$(".smiley-icon").addClass("dead")}function aq(aE,aD){return R[aE][aD].triggered}function au(aE,aD){var aF=R[aE][aD];return !aF.triggered&&!aF.marked&&!aF.flagged}function I(aE,aD){return R[aE][aD].number!=0}function ax(aE,aD){return R[aE][aD].marked}function O(aE,aD){return R[aE][aD].flagged}function e(aE,aD){return R[aE][aD].isMine}function Z(aE,aD){return R[aE][aD].number}function af(aE,aD){var aG=$('.ms-panel[data-coord="'+aE+","+aD+'"]');var aF=R[aE][aD];aG.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(aF.triggered){aG.addClass("triggered");if(aF.number>0){aG.addClass("m"+aF.number)}if(aF.isMine){aG.addClass("mine")}if(aF.exploded){aG.addClass("exploded")}if(!aF.isMine&&aF.flagged){aG.addClass("bogus")}}else{if(aF.flagged){aG.addClass("flagged")}if(aF.marked){aG.addClass("marked")}}}function ap(){X();K=setInterval(function(){X()},1000)}function t(){clearInterval(K)}function X(){if(q){if(T<999){T++;i("time",T);if(w){document.getElementById("snd_tick").play()}}}}function aj(){if(p<c){p++;i("mines",p)}}function V(){if(p>-99){p--;i("mines",(p>-100)?p:-99)}}function i(aG,aF){aG=".num-box#"+aG;num=Math.abs(aF);var aE=Math.floor(num/100);num-=aE*100;var aD=Math.floor(num/10);num-=aD*10;if(aF<0){aE="n"}$(aG+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(aG+" .digit.iii").addClass("d"+aE);$(aG+" .digit.ii").addClass("d"+aD);$(aG+" .digit.i").addClass("d"+num)}function J(aO){an();C=true;g=false;H=true;q=true;if(aO<0||aO>3||(aO==3&&!at)){aO=0}var aI={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};if(aO!=3){var aG=aI.width[aO];var aR=aI.height[aO];var aQ=aI.mines[aO]}else{var aG=aB;var aR=Y;var aQ=av}c=aQ;p=aQ;u=aG;G=aR;M=aO;ab=false;T=0;R=[];ao=(aG*aR)-aQ;if(h){h=false;var aM=v("leaderboard");var aK=x;try{if(aM!=null){aK=$.parseJSON(aM)}}catch(aL){console.log("Error: leaderboard data is corrupt. Resetting to default...");l("leaderboard",JSON.stringify(x))}for(var aF=0;aF<3;aF++){al(aF,aK[aF][0],aK[aF][1],true)}var aP=v("snd");aP=(aP=="true")?true:false;aw(aP,true);var aE=v("mrk");aE=(aE=="true"||aE==null)?true:false;s(aE,true);var aH=v("clr");aH=(aH=="true"||aH==null)?true:false;d(aH,true);var aN=v("lvl");var aD=v("board_width");var aJ=v("board_height");var aS=v("board_mines");if(aN!==null){if(aN!=3||(aD!==null&&aJ!=null&&aS!=null)){if(aN==3){f(aD,aJ,aS,true)}az(aN,true);return}}}ag();i("time",T);i("mines",p);$(".smiley-icon").removeClass("active cool dead");ay();D.showWindow($("#ms-main"),40,40)}function ag(){var aG="";for(var aF=0;aF<G;aF++){R.push([]);aG+="<div class='ms-row'>";for(var aE=0;aE<u;aE++){R[aF].push(new am());aG+="<div class='ms-panel' data-coord='"+aF+","+aE+"'></div>"}aG+="</div>"}var aD=c;while(aD--){F()}$(".ms-grid").html(aG)}function F(aE,aG){var aI=typeof aE!="undefined";var aH=-1;var aD=-1;var aF=null;do{aH=ar(0,G-1);aD=ar(0,u-1);aF=R[aH][aD]}while(aF.isMine||(aI&&aH==aE&&aD==aG));R[aH][aD].number=0;n(aH,aD);E(aH,aD)}function E(aJ,aG,aE){var aI=j(aJ,aG);var aD=0;for(var aH=aI[0][0];aH<=aI[0][1];aH++){for(var aF=aI[1][0];aF<=aI[1][1];aF++){if(e(aH,aF)){aD++;continue}if((aJ==aH&&aG==aF)){continue}if(!aE){R[aH][aF].number++}else{R[aH][aF].number--}}}if(aE){R[aJ][aG].number=aD}}function ar(aE,aD){return Math.floor(Math.random()*(aD+1-aE))+aE}function j(aH,aF){var aG=(aH==0)?0:aH-1;var aI=(aH==G-1)?G-1:aH+1;var aD=(aF==0)?0:aF-1;var aE=(aF==u-1)?u-1:aF+1;return[[aG,aI],[aD,aE]]}function S(){return !C&&!g}function o(){if(C){C=false;g=false;ap()}}function an(){g=true;t()}function a(){$(".smiley-icon").addClass("cool");if(w){document.getElementById("snd_win").play()}if(M<3&&M>=0){if(x[M][1]>T){var aF=["beginner","intermediate","expert"];var aD=$("#ms-high-score #hs-description");var aH=aD.data("hs-msg").replace("%LEVEL%",aF[M]);aD.html(aH);$("#ms-high-score #hs-name").val(x[M][0]);var aG=$(".minesweeper").offset();var aE=$(".ms-status").offset().top+$(".ms-status").outerHeight();D.showWindow($("#ms-high-score"),aG.left,aE,$("#ms-main"));$("#ms-high-score #hs-name").select()}}an()}function al(aE,aF,aH,aG){if(aE<0||aE>2||aH<0||aH>999){return}aF=aF.substr(0,32);x[aE][0]=aF;x[aE][1]=aH;if(!aG){l("leaderboard",JSON.stringify(x))}var aI=$("#ms-leaderboard .leader-container .row[data-leader-row="+aE+"]");var aD=$("#ms-leaderboard .leader-container").data("time-string").replace("%TIME%",aH);aI.find(".time").first().html(aD);aI.find(".name").first().html(aF)}function P(){for(var aD=0;aD<2;aD++){al(aD,"Anonymous",999)}}function v(aD){if(typeof window.localStorage!="undefined"){return window.localStorage.getItem(aD)}return null}function l(aD,aE){if(typeof window.localStorage!="undefined"){window.localStorage.setItem(aD,aE)}}})();