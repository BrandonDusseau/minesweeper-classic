(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var y=window.SweeperOSEnvironment;var F=null;var N=0;var x=true;var C=true;var g=false;var V=false;var o=0;var c=0;var G=0;var r=0;var B=0;var L=null;var ai=0;var H=false;var j=false;var O=true;var s=false;var w=true;var am=false;var av=9;var S=9;var ao=10;var h=true;var t=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function ag(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(ax){$(".smiley-icon").removeClass("active");H=false;j=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(ax){if($(".window#ms-main").hasClass("focused")){if(ax.which==113){ax.preventDefault();E(G)}else{if(ax.which==112){ax.preventDefault()}}return}if($(".window#ms-custom-board").hasClass("focused")){if(ax.which==27){ae()}else{if(ax.which==13){if($(".cst-form input").is(":focus")){v()}else{$("#ms-custom-board .btns .btn-container.active").click()}}}return}if($(".window#ms-high-score").hasClass("focused")){if(ax.which==27||ax.which==13){u()}return}if($(".window#ms-leaderboard").hasClass("focused")){if(ax.which==27){Q()}else{if(ax.which==13){$(this).find("#ms-leaderboard .btns .btn-container.active").click()}}return}if($(".window#ms-about").hasClass("focused")){if(ax.which==27||ax.which==13){K()}return}});$(".minesweeper").off("mousedown").on("mousedown",function(ax){if(!g&&(ax.which==1||ax.which==2)){$(".smiley-icon").addClass("active")}});$(".smiley-btn").off("click").on("click",function(ax){E(G)});$("#game_new").on("click",function(ax){E(G)});$("#game_beg:not(.disabled)").on("click",function(ax){at(0)});$("#game_int:not(.disabled)").on("click",function(ax){at(1)});$("#game_exp:not(.disabled)").on("click",function(ax){at(2)});$("#game_cst:not(.disabled)").on("click",function(ay){var ax=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(S);$("#ms-custom-board #cst-width").val(av);$("#ms-custom-board #cst-mines").val(ao);y.showWindow($("#ms-custom-board"),ax.left,ax.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(ax){p(!O)});$("#game_snd:not(.disabled)").on("click",function(ax){ap(!s)});$("#game_clr:not(.disabled)").on("click",function(ax){d(!w)});$("#game_ldr:not(.disabled)").on("click",function(ax){U()});$("#help_abt:not(.disabled)").on("click",function(ax){X()});$("#cst_ok").on("click",v);$("#cst_cancel").on("click",ae);$("#hs_ok").on("click",u);$("#leader_ok").on("click",Q);$("#leader_reset").on("click",J);$("#about_ok").on("click",K);E(0)});function v(){var az=$("#cst-width").val();var ay=$("#cst-height").val();var ax=$("#cst-mines").val();f(az,ay,ax);at(3);y.closeWindow($("#ms-custom-board"))}function ae(){E(G);y.closeWindow($("#ms-custom-board"))}function u(){af(G,$("#ms-high-score #hs-name").val(),N);y.closeWindow($("#ms-high-score"));U()}function Q(){y.closeWindow($("#ms-leaderboard"))}function U(){var ay=$(".minesweeper").offset();var ax=$(".ms-status").offset().top+$(".ms-status").outerHeight();y.showWindow($("#ms-leaderboard"),ay.left,ax,$("#ms-main"))}function X(){var ax=$(".minesweeper").offset();y.showWindow($("#ms-about"),ax.left+30,ax.top+33,$("#ms-main"))}function K(){y.closeWindow($("#ms-about"))}function ap(ax,ay){if(ax==true){s=true;$("#game_snd").addClass("checked")}else{s=false;$("#game_snd").removeClass("checked")}if(!ay){localStorage.setItem("snd",s)}}function p(ax,ay){if(ax==true){O=true;$("#game_mrk").addClass("checked")}else{O=false;$("#game_mrk").removeClass("checked")}if(!ay){localStorage.setItem("mrk",O)}}function d(ax,ay){if(ax==true){w=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{w=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!ay){localStorage.setItem("clr",w)}}function at(aB,aA){if(aB<0||aB>3){return}if(aB!=3){av=9;S=9;ao=10;am=false}var ax=["beg","int","exp","cst"];for(var az=0;az<ax.length;az++){var ay=$("#game_"+ax[az]);if(az==aB){ay.addClass("checked")}else{ay.removeClass("checked")}}if(!aA){localStorage.setItem("lvl",aB)}E(aB)}function f(aA,ax,aB,az){if(!/^\d*$/.test(aA)){aA=9}aA=(aA>30?30:aA);aA=(aA<9?9:aA);if(!/^\d*$/.test(ax)){ax=9}ax=(ax>24?24:ax);ax=(ax<9?9:ax);if(!/^\d*$/.test(aB)){aB=10}aB=(aB<10?10:aB);var ay=(ax-1)*(aA-1);aB=(aB>ay?ay:aB);am=true;av=aA;S=ax;ao=aB;if(!az){localStorage.setItem("board_width",aA);localStorage.setItem("board_height",ax);localStorage.setItem("board_mines",aB)}}function ar(){$(".window *").off("contextmenu").on("contextmenu",function(ax){ax.preventDefault()});$(".ms-panel").off("mousedown").on("mousedown",function(ay){if(!g){switch(ay.which){case 1:H=true;$(this).trigger("mouseenter");break;case 2:j=true;$(this).trigger("mouseenter");break;case 3:var ax=$(this);b(ax,ay);break}}});$(".ms-panel").off("mouseenter").on("mouseenter",function(aB){if(H&&!$(this).hasClass("flagged")){$(this).addClass("down")}else{if(j){var aA=Y($(this));var az=k(aA[0],aA[1]);for(var ay=az[0][0];ay<=az[0][1];ay++){for(var ax=az[1][0];ax<=az[1][1];ax++){if(!I(ay,ax)){$('.ms-panel[data-coord="'+ay+","+ax+'"]').addClass("down")}}}}}});$(".ms-panel").off("mouseleave").on("mouseleave",function(ax){if((H||j)&&(ax.which==1||ax.which==2)){$(".ms-panel.down").removeClass("down")}});$(".ms-panel").off("mouseup").on("mouseup",function(ay){if((H||j)&&!g){if(x){n()}var ax=$(this);b(ax,ay)}})}function b(aG,aH){if(!aG.length||!aG.hasClass("ms-panel")){return}var aE=Y(aG);var aJ=aE[0];var ay=aE[1];if(aH.which==1){$(".smiley-icon").removeClass("active");H=false;if(!g){if(!ak(aJ,ay)){ac(aJ,ay)}}}if(aH.which==2&&D(aJ,ay)&&ak(aJ,ay)){var ax=k(aJ,ay);var az=[];var aF=T(aJ,ay);for(var aC=ax[0][0];aC<=ax[0][1];aC++){for(var aB=ax[1][0];aB<=ax[1][1];aB++){if(aC==aJ&&aB==ay){continue}if(I(aC,aB)){aF--}else{az.push([aC,aB])}}}if(aF!==0){return}var aA=az.length;for(var aC=0;aC<aA;aC++){var aD=az[aC][0];var aI=az[aC][1];if(e(aD,aI)){az.splice(aC,1);az.push([aD,aI]);aA--;aC--}}for(var aC=0;aC<az.length;aC++){var aD=az[aC][0];var aI=az[aC][1];ac(aD,aI)}}else{if(aH.which==3){if(!g&&!ak(aJ,ay)){if(!I(aJ,ay)&&!aq(aJ,ay)){aw(aJ,ay);P()}else{if(O&&I(aJ,ay)){ab(aJ,ay);ad()}else{if(!O){ad()}W(aJ,ay)}}}}}}function Y(ay){var ax=ay.data("coord").split(",");return[parseInt(ax[0],10),parseInt(ax[1],10)]}function aw(az,ax){var ay=L[az][ax];if(!g&&!ay.triggered&&!ay.marked){L[az][ax].flagged=true}Z(az,ax)}function ab(az,ax){var ay=L[az][ax];if(!g&&!ay.triggered&&ay.flagged){ay.flagged=false;ay.marked=true}L[az][ax]=ay;Z(az,ax)}function W(az,ax){var ay=L[az][ax];if(!g&&!ay.triggered){ay.marked=false;ay.flagged=false}L[az][ax]=ay;Z(az,ax)}function ac(az,ax){var ay=L[az][ax];if(g||ay.triggered||ay.flagged){return}ay.triggered=true;L[az][ax]=ay;if(!C&&ay.isMine){l(az,ax);return}else{if(C&&ay.isMine){L[az][ax].isMine=false;z(az,ax,true);A(az,ax)}}Z(az,ax);if(ay.number==0&&!ay.isMine&&!ay.flagged){au(az,ax)}if(--ai==0){a()}C=false}function au(aF,ay){var ax=(aF==0)?0:aF-1;var aE=(aF==B-1)?B-1:aF+1;var aC=(ay==0)?0:ay-1;var az=(ay==r-1)?r-1:ay+1;for(var aB=ax;aB<=aE;aB++){for(var aA=aC;aA<=az;aA++){var aD=L[aB][aA];if(aD.number>0||(!aD.isMine&&!aD.flagged)){ac(aB,aA)}}}}function m(ay,ax){L[ay][ax].isMine=true}function l(ay,ax){var aA=L[ay][ax];if(!aA.isMine){return}aA.exploded=true;L[ay][ax]=aA;if(s){document.getElementById("snd_explode").play()}ah();for(var ay=0;ay<B;ay++){for(var ax=0;ax<r;ax++){var az=L[ay][ax];var aB=false;if(!az.flagged&&az.isMine){aB=true}else{if(!az.isMine&&az.flagged){aB=true;az.number=0}}if(aB){az.triggered=true;L[ay][ax]=az;Z(ay,ax)}}}$(".smiley-icon").addClass("dead")}function ak(ay,ax){return L[ay][ax].triggered}function an(ay,ax){var az=L[ay][ax];return !az.triggered&&!az.marked&&!az.flagged}function D(ay,ax){return L[ay][ax].number!=0}function aq(ay,ax){return L[ay][ax].marked}function I(ay,ax){return L[ay][ax].flagged}function e(ay,ax){return L[ay][ax].isMine}function T(ay,ax){return L[ay][ax].number}function Z(ay,ax){var aA=$('.ms-panel[data-coord="'+ay+","+ax+'"]');var az=L[ay][ax];aA.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(az.triggered){aA.addClass("triggered");if(az.number>0){aA.addClass("m"+az.number)}if(az.isMine){aA.addClass("mine")}if(az.exploded){aA.addClass("exploded")}if(!az.isMine&&az.flagged){aA.addClass("bogus")}}else{if(az.flagged){aA.addClass("flagged")}if(az.marked){aA.addClass("marked")}}}function aj(){R();F=setInterval(function(){R()},1000)}function q(){clearInterval(F)}function R(){if(N<999){N++;i("time",N);if(s){document.getElementById("snd_tick").play()}}}function ad(){if(o<c){o++;i("mines",o)}}function P(){if(o>-99){o--;i("mines",(o>-100)?o:-99)}}function i(aA,az){aA=".num-box#"+aA;num=Math.abs(az);var ay=Math.floor(num/100);num-=ay*100;var ax=Math.floor(num/10);num-=ax*10;if(az<0){ay="n"}$(aA+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(aA+" .digit.iii").addClass("d"+ay);$(aA+" .digit.ii").addClass("d"+ax);$(aA+" .digit.i").addClass("d"+num)}function E(aI){ah();x=true;g=false;C=true;if(aI<0||aI>3||(aI==3&&!am)){aI=0}var aC={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};if(aI!=3){var aA=aC.width[aI];var aL=aC.height[aI];var aK=aC.mines[aI]}else{var aA=av;var aL=S;var aK=ao}c=aK;o=aK;r=aA;B=aL;G=aI;V=false;N=0;L=[];ai=(aA*aL)-aK;if(h){h=false;var aG=localStorage.getItem("leaderboard");var aE=t;try{if(aG!=null){aE=$.parseJSON(aG)}}catch(aF){console.log("Error: leaderboard data is corrupt. Resetting to default...");localStorage.setItem("leaderboard",JSON.stringify(t))}for(var az=0;az<3;az++){af(az,aE[az][0],aE[az][1],true)}var aJ=localStorage.getItem("snd");aJ=(aJ=="true")?true:false;ap(aJ,true);var ay=localStorage.getItem("mrk");ay=(ay=="true"||ay==null)?true:false;p(ay,true);var aB=localStorage.getItem("clr");aB=(aB=="true"||aB==null)?true:false;d(aB,true);var aH=localStorage.getItem("lvl");var ax=localStorage.getItem("board_width");var aD=localStorage.getItem("board_height");var aM=localStorage.getItem("board_mines");if(aH!==null){if(aH!=3||(ax!==null&&aD!=null&&aM!=null)){if(aH==3){f(ax,aD,aM,true)}at(aH,true);return}}}aa();i("time",N);i("mines",o);$(".smiley-icon").removeClass("active cool dead");ar();y.showWindow($("#ms-main"),40,40)}function aa(){var aA="";for(var az=0;az<B;az++){L.push([]);aA+="<div class='ms-row'>";for(var ay=0;ay<r;ay++){L[az].push(new ag());aA+="<div class='ms-panel' data-coord='"+az+","+ay+"'></div>"}aA+="</div>"}var ax=c;while(ax--){A()}$(".ms-grid").html(aA)}function A(ay,aA){var aC=typeof ay!="undefined";var aB=-1;var ax=-1;var az=null;do{aB=al(0,B-1);ax=al(0,r-1);az=L[aB][ax]}while(az.isMine||(aC&&aB==ay&&ax==aA));L[aB][ax].number=0;m(aB,ax);z(aB,ax)}function z(aD,aA,ay){var aC=k(aD,aA);var ax=0;for(var aB=aC[0][0];aB<=aC[0][1];aB++){for(var az=aC[1][0];az<=aC[1][1];az++){if(e(aB,az)){ax++;continue}if((aD==aB&&aA==az)){continue}if(!ay){L[aB][az].number++}else{L[aB][az].number--}}}if(ay){L[aD][aA].number=ax}}function al(ay,ax){return Math.floor(Math.random()*(ax+1-ay))+ay}function k(aB,az){var aA=(aB==0)?0:aB-1;var aC=(aB==B-1)?B-1:aB+1;var ax=(az==0)?0:az-1;var ay=(az==r-1)?r-1:az+1;return[[aA,aC],[ax,ay]]}function M(){return !x&&!g}function n(){if(x){x=false;g=false;aj()}}function ah(){g=true;q()}function a(){$(".smiley-icon").addClass("cool");if(s){document.getElementById("snd_win").play()}if(G<3&&G>=0){if(t[G][1]>N){var az=["beginner","intermediate","expert"];var ax=$("#ms-high-score #hs-description");var aB=ax.data("hs-msg").replace("%LEVEL%",az[G]);ax.html(aB);$("#ms-high-score #hs-name").val(t[G][0]);var aA=$(".minesweeper").offset();var ay=$(".ms-status").offset().top+$(".ms-status").outerHeight();y.showWindow($("#ms-high-score"),aA.left,ay,$("#ms-main"));$("#ms-high-score #hs-name").select()}}ah()}function af(ay,az,aB,aA){if(ay<0||ay>2||aB<0||aB>999){return}az=az.substr(0,32);t[ay][0]=az;t[ay][1]=aB;if(!aA){localStorage.setItem("leaderboard",JSON.stringify(t))}var aC=$("#ms-leaderboard .leader-container .row[data-leader-row="+ay+"]");var ax=$("#ms-leaderboard .leader-container").data("time-string").replace("%TIME%",aB);aC.find(".time").first().html(ax);aC.find(".name").first().html(az)}function J(){for(var ax=0;ax<2;ax++){af(ax,"Anonymous",999)}}})();