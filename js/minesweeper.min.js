(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var g=window.SweeperOSEnvironment;var K=null;var ab=0;var D=true;var k=true;var E=false;var y=false;var M=0;var ad=0;var l=0;var ai=0;var aj=0;var T=null;var I=0;var ah=false;var Y=false;var X=true;var S=false;var N=true;var d=false;var ak=9;var n=9;var o=10;var ag=true;var Q=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function a(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(ar){$(".smiley-icon").removeClass("active");ah=false;Y=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(ar){if($(".window#ms-main").hasClass("focused")){if(ar.which==113){ar.preventDefault();m(l)}else{if(ar.which==112){ar.preventDefault()}}}if($(".window#ms-custom-board").hasClass("focused")){if(ar.which==27){an()}else{if(ar.which==13){W()}}}if($(".window#ms-high-score").hasClass("focused")){if(ar.which==27||ar.which==13){u()}}});$(".minesweeper").off("mousedown").on("mousedown",function(ar){if(!E&&(ar.which==1||ar.which==2)){$(".smiley-icon").addClass("active")}});$(".smiley-btn").off("click").on("click",function(ar){m(l)});$("#game_new").on("click",function(ar){m(l)});$("#game_beg:not(.disabled)").on("click",function(ar){p(0)});$("#game_int:not(.disabled)").on("click",function(ar){p(1)});$("#game_exp:not(.disabled)").on("click",function(ar){p(2)});$("#game_cst:not(.disabled)").on("click",function(at){var ar=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(n);$("#ms-custom-board #cst-width").val(ak);$("#ms-custom-board #cst-mines").val(o);g.showWindow($("#ms-custom-board"),ar.left,ar.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(ar){F(!X)});$("#game_snd:not(.disabled)").on("click",function(ar){B(!S)});$("#game_clr:not(.disabled)").on("click",function(ar){x(!N)});$("#cst_ok").on("click",W);$("#cst_cancel").on("click",an);$("#hs_ok").on("click",u);m(0)});function W(){var au=$("#cst-width").val();var at=$("#cst-height").val();var ar=$("#cst-mines").val();v(au,at,ar);p(3);g.closeWindow($("#ms-custom-board"))}function an(){m(l);g.closeWindow($("#ms-custom-board"))}function u(){f(l,$("#ms-high-score #hs-name").val(),ab);g.closeWindow($("#ms-high-score"))}function B(ar,at){if(ar==true){S=true;$("#game_snd").addClass("checked")}else{S=false;$("#game_snd").removeClass("checked")}if(!at){localStorage.setItem("snd",S)}}function F(ar,at){if(ar==true){X=true;$("#game_mrk").addClass("checked")}else{X=false;$("#game_mrk").removeClass("checked")}if(!at){localStorage.setItem("mrk",X)}}function x(ar,at){if(ar==true){N=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{N=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!at){localStorage.setItem("clr",N)}}function p(aw,av){if(aw<0||aw>3){return}if(aw!=3){ak=9;n=9;o=10;d=false}var ar=["beg","int","exp","cst"];for(var au=0;au<ar.length;au++){var at=$("#game_"+ar[au]);if(au==aw){at.addClass("checked")}else{at.removeClass("checked")}}if(!av){localStorage.setItem("lvl",aw)}m(aw)}function v(av,ar,aw,au){if(!/^\d*$/.test(av)){av=9}av=(av>30?30:av);av=(av<9?9:av);if(!/^\d*$/.test(ar)){ar=9}ar=(ar>24?24:ar);ar=(ar<9?9:ar);if(!/^\d*$/.test(aw)){aw=10}aw=(aw<10?10:aw);var at=(ar-1)*(av-1);aw=(aw>at?at:aw);d=true;ak=av;n=ar;o=aw;if(!au){localStorage.setItem("board_width",av);localStorage.setItem("board_height",ar);localStorage.setItem("board_mines",aw)}}function z(){$(".window *").off("contextmenu").on("contextmenu",function(ar){ar.preventDefault()});$(".ms-panel").off("mousedown").on("mousedown",function(at){if(!E){switch(at.which){case 1:ah=true;$(this).trigger("mouseenter");break;case 2:Y=true;$(this).trigger("mouseenter");break;case 3:var ar=$(this);ac(ar,at);break}}});$(".ms-panel").off("mouseenter").on("mouseenter",function(aw){if(ah&&!$(this).hasClass("flagged")){$(this).addClass("down")}else{if(Y){var av=aa($(this));var au=b(av[0],av[1]);for(var at=au[0][0];at<=au[0][1];at++){for(var ar=au[1][0];ar<=au[1][1];ar++){if(!A(at,ar)){$('.ms-panel[data-coord="'+at+","+ar+'"]').addClass("down")}}}}}});$(".ms-panel").off("mouseleave").on("mouseleave",function(ar){if((ah||Y)&&(ar.which==1||ar.which==2)){$(".ms-panel.down").removeClass("down")}});$(".ms-panel").off("mouseup").on("mouseup",function(at){if((ah||Y)&&!E){if(D){V()}var ar=$(this);ac(ar,at)}})}function ac(aB,aC){if(!aB.length||!aB.hasClass("ms-panel")){return}var az=aa(aB);var aE=az[0];var at=az[1];if(aC.which==1){$(".smiley-icon").removeClass("active");ah=false;if(!E){if(!al(aE,at)){L(aE,at)}}}if(aC.which==2&&ap(aE,at)&&al(aE,at)){var ar=b(aE,at);var au=[];var aA=H(aE,at);for(var ax=ar[0][0];ax<=ar[0][1];ax++){for(var aw=ar[1][0];aw<=ar[1][1];aw++){if(ax==aE&&aw==at){continue}if(A(ax,aw)){aA--}else{au.push([ax,aw])}}}if(aA!==0){return}var av=au.length;for(var ax=0;ax<av;ax++){var ay=au[ax][0];var aD=au[ax][1];if(j(ay,aD)){au.splice(ax,1);au.push([ay,aD]);av--;ax--}}for(var ax=0;ax<au.length;ax++){var ay=au[ax][0];var aD=au[ax][1];L(ay,aD)}}else{if(aC.which==3){if(!E&&!al(aE,at)){if(!A(aE,at)&&!e(aE,at)){P(aE,at);t()}else{if(X&&A(aE,at)){h(aE,at);aq()}else{if(!X){aq()}U(aE,at)}}}}}}function aa(at){var ar=at.data("coord").split(",");return[parseInt(ar[0],10),parseInt(ar[1],10)]}function P(au,ar){var at=T[au][ar];if(!E&&!at.triggered&&!at.marked){T[au][ar].flagged=true}Z(au,ar)}function h(au,ar){var at=T[au][ar];if(!E&&!at.triggered&&at.flagged){at.flagged=false;at.marked=true}T[au][ar]=at;Z(au,ar)}function U(au,ar){var at=T[au][ar];if(!E&&!at.triggered){at.marked=false;at.flagged=false}T[au][ar]=at;Z(au,ar)}function L(au,ar){var at=T[au][ar];if(E||at.triggered||at.flagged){return}at.triggered=true;T[au][ar]=at;if(!k&&at.isMine){r(au,ar);return}else{if(k&&at.isMine){T[au][ar].isMine=false;ae(au,ar,true);s(au,ar)}}Z(au,ar);if(at.number==0&&!at.isMine&&!at.flagged){G(au,ar)}if(--I==0){R()}k=false}function G(aA,at){var ar=(aA==0)?0:aA-1;var az=(aA==aj-1)?aj-1:aA+1;var ax=(at==0)?0:at-1;var au=(at==ai-1)?ai-1:at+1;for(var aw=ar;aw<=az;aw++){for(var av=ax;av<=au;av++){var ay=T[aw][av];if(ay.number>0||(!ay.isMine&&!ay.flagged)){L(aw,av)}}}}function O(at,ar){T[at][ar].isMine=true}function r(at,ar){var av=T[at][ar];if(!av.isMine){return}av.exploded=true;T[at][ar]=av;if(S){document.getElementById("snd_explode").play()}am();for(var at=0;at<aj;at++){for(var ar=0;ar<ai;ar++){var au=T[at][ar];var aw=false;if(!au.flagged&&au.isMine){aw=true}else{if(!au.isMine&&au.flagged){aw=true;au.number=0}}if(aw){au.triggered=true;T[at][ar]=au;Z(at,ar)}}}$(".smiley-icon").addClass("dead")}function al(at,ar){return T[at][ar].triggered}function c(at,ar){var au=T[at][ar];return !au.triggered&&!au.marked&&!au.flagged}function ap(at,ar){return T[at][ar].number!=0}function e(at,ar){return T[at][ar].marked}function A(at,ar){return T[at][ar].flagged}function j(at,ar){return T[at][ar].isMine}function H(at,ar){return T[at][ar].number}function Z(at,ar){var av=$('.ms-panel[data-coord="'+at+","+ar+'"]');var au=T[at][ar];av.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(au.triggered){av.addClass("triggered");if(au.number>0){av.addClass("m"+au.number)}if(au.isMine){av.addClass("mine")}if(au.exploded){av.addClass("exploded")}if(!au.isMine&&au.flagged){av.addClass("bogus")}}else{if(au.flagged){av.addClass("flagged")}if(au.marked){av.addClass("marked")}}}function q(){af();K=setInterval(function(){af()},1000)}function i(){clearInterval(K)}function af(){if(ab<999){ab++;ao("time",ab);if(S){document.getElementById("snd_tick").play()}}}function aq(){if(M<ad){M++;ao("mines",M)}}function t(){if(M>-99){M--;ao("mines",(M>-100)?M:-99)}}function ao(av,au){av=".num-box#"+av;num=Math.abs(au);var at=Math.floor(num/100);num-=at*100;var ar=Math.floor(num/10);num-=ar*10;if(au<0){at="n"}$(av+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(av+" .digit.iii").addClass("d"+at);$(av+" .digit.ii").addClass("d"+ar);$(av+" .digit.i").addClass("d"+num)}function m(aB){am();D=true;E=false;k=true;if(aB<0||aB>3||(aB==3&&!d)){aB=0}var aw={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};if(aB!=3){var au=aw.width[aB];var aE=aw.height[aB];var aC=aw.mines[aB]}else{var au=ak;var aE=n;var aC=o}ad=aC;M=aC;ai=au;aj=aE;l=aB;y=false;ab=0;T=[];I=(au*aE)-aC;if(ag){ag=false;var az=localStorage.getItem("leaderboard");try{if(az!=null){Q=$.parseJSON(az)}}catch(ay){console.log("Error: leaderboard data is corrupt. Resetting to default...");localStorage.setItem("leaderboard",JSON.stringify(Q))}var aD=localStorage.getItem("snd");aD=(aD=="true"||aD==null)?true:false;B(aD,true);var at=localStorage.getItem("mrk");at=(at=="true"||at==null)?true:false;F(at,true);var av=localStorage.getItem("clr");av=(av=="true"||av==null)?true:false;x(av,true);var aA=localStorage.getItem("lvl");var ar=localStorage.getItem("board_width");var ax=localStorage.getItem("board_height");var aF=localStorage.getItem("board_mines");if(aA!==null){if(aA!=3||(ar!==null&&ax!=null&&aF!=null)){if(aA==3){v(ar,ax,aF,true)}p(aA,true);return}}}C();ao("time",ab);ao("mines",M);$(".smiley-icon").removeClass("active cool dead");z();g.showWindow($("#ms-main"))}function C(){var av="";for(var au=0;au<aj;au++){T.push([]);av+="<div class='ms-row'>";for(var at=0;at<ai;at++){T[au].push(new a());av+="<div class='ms-panel' data-coord='"+au+","+at+"'></div>"}av+="</div>"}var ar=ad;while(ar--){s()}$(".ms-grid").html(av)}function s(at,av){var ax=typeof at!="undefined";var aw=-1;var ar=-1;var au=null;do{aw=w(0,aj-1);ar=w(0,ai-1);au=T[aw][ar]}while(au.isMine||(ax&&aw==at&&ar==av));T[aw][ar].number=0;O(aw,ar);ae(aw,ar)}function ae(ay,av,at){var ax=b(ay,av);var ar=0;for(var aw=ax[0][0];aw<=ax[0][1];aw++){for(var au=ax[1][0];au<=ax[1][1];au++){if(j(aw,au)){ar++;continue}if((ay==aw&&av==au)){continue}if(!at){T[aw][au].number++}else{T[aw][au].number--}}}if(at){T[ay][av].number=ar}}function w(at,ar){return Math.floor(Math.random()*(ar+1-at))+at}function b(aw,au){var av=(aw==0)?0:aw-1;var ax=(aw==aj-1)?aj-1:aw+1;var ar=(au==0)?0:au-1;var at=(au==ai-1)?ai-1:au+1;return[[av,ax],[ar,at]]}function J(){return !D&&!E}function V(){if(D){D=false;E=false;q()}}function am(){E=true;i()}function R(){$(".smiley-icon").addClass("cool");if(S){document.getElementById("snd_win").play()}if(l<3&&l>=0){if(Q[l][1]>ab){var au=["beginner","intermediate","expert"];var ar=$("#ms-high-score #hs-description");var aw=ar.data("hs-msg").replace("%LEVEL%",au[l]);ar.html(aw);$("#ms-high-score #hs-name").val(Q[l][0]);var av=$(".minesweeper").offset();var at=$(".ms-status").offset().top+$(".ms-status").outerHeight();g.showWindow($("#ms-high-score"),av.left,at,$("#ms-main"));$("#ms-high-score #hs-name").select()}}am()}function f(ar,at,au){if(ar<0||ar>2||au<0||au>999){return}Q[ar][0]=at;Q[ar][1]=au;localStorage.setItem("leaderboard",JSON.stringify(Q))}})();