(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var env=window.SweeperOSEnvironment;var timer=null;var time=0;var gameWaiting=true;var noMoves=true;var gameOver=false;var exploded=false;var minesLeft=0;var maxMines=0;var difficulty=0;var boardWidth=0;var boardHeight=0;var tiles=null;var tilesLeft=0;var tileActive=false;var groupActive=false;var allowMarks=true;var allowSound=false;var allowColor=true;var customSet=false;var customWidth=9;var customHeight=9;var customMines=10;var firstGame=true;var leaderboard=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function Tile(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(e){$(".smiley-icon").removeClass("active");tileActive=false;groupActive=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(e){if($(".window#ms-main").hasClass("focused")){if(e.which==113){e.preventDefault();initGame(difficulty)}else if(e.which==112){e.preventDefault()}return}if($(".window#ms-custom-board").hasClass("focused")){if(e.which==27){customBoardCancel()}else if(e.which==13){if($(".cst-form input").is(":focus")){customBoardConfirm()}else{$("#ms-custom-board .btns .btn-container.active").click()}}return}if($(".window#ms-high-score").hasClass("focused")){if(e.which==27||e.which==13){highScoreConfirm()}return}if($(".window#ms-leaderboard").hasClass("focused")){if(e.which==27){leaderboardConfirm()}else if(e.which==13){$(this).find("#ms-leaderboard .btns .btn-container.active").click()}return}if($(".window#ms-about").hasClass("focused")){if(e.which==27||e.which==13){aboutConfirm()}return}});$(".minesweeper").off("mousedown").on("mousedown",function(e){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!gameOver&&(e.which==1||e.which==2)){$(".smiley-icon").addClass("active")}});$(".smiley-btn").off("click").on("click",function(e){initGame(difficulty)});$("#game_new").on("click",function(e){initGame(difficulty)});$("#game_beg:not(.disabled)").on("click",function(e){setDifficulty(0)});$("#game_int:not(.disabled)").on("click",function(e){setDifficulty(1)});$("#game_exp:not(.disabled)").on("click",function(e){setDifficulty(2)});$("#game_cst:not(.disabled)").on("click",function(e){var containerOffset=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(customHeight);$("#ms-custom-board #cst-width").val(customWidth);$("#ms-custom-board #cst-mines").val(customMines);env.showWindow($("#ms-custom-board"),containerOffset.left,containerOffset.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(e){setMarks(!allowMarks)});$("#game_snd:not(.disabled)").on("click",function(e){setSound(!allowSound)});$("#game_clr:not(.disabled)").on("click",function(e){setColor(!allowColor)});$("#game_ldr:not(.disabled)").on("click",function(e){openLeaderboard()});$("#help_abt:not(.disabled)").on("click",function(e){openAbout()});$("#cst_ok").on("click",customBoardConfirm);$("#cst_cancel").on("click",customBoardCancel);$("#hs_ok").on("click",highScoreConfirm);$("#leader_ok").on("click",leaderboardConfirm);$("#leader_reset").on("click",resetLeaderboard);$("#about_ok").on("click",aboutConfirm);initGame(0)});function customBoardConfirm(){var cstWidth=$("#cst-width").val();var cstHeight=$("#cst-height").val();var cstMines=$("#cst-mines").val();setCustomBoard(cstWidth,cstHeight,cstMines);setDifficulty(3);env.closeWindow($("#ms-custom-board"))}function customBoardCancel(){initGame(difficulty);env.closeWindow($("#ms-custom-board"))}function highScoreConfirm(){updateLeaderboard(difficulty,$("#ms-high-score #hs-name").val(),time);env.closeWindow($("#ms-high-score"));openLeaderboard()}function leaderboardConfirm(){env.closeWindow($("#ms-leaderboard"))}function openLeaderboard(){var containerOffset=$(".minesweeper").offset();var statusOffset=$(".ms-status").offset().top+$(".ms-status").outerHeight();env.showWindow($("#ms-leaderboard"),containerOffset.left,statusOffset,$("#ms-main"))}function openAbout(){var containerOffset=$(".minesweeper").offset();env.showWindow($("#ms-about"),containerOffset.left+30,containerOffset.top+33,$("#ms-main"))}function aboutConfirm(){env.closeWindow($("#ms-about"))}function setSound(enabled,skipSave){if(enabled==true){allowSound=true;$("#game_snd").addClass("checked")}else{allowSound=false;$("#game_snd").removeClass("checked")}if(!skipSave){localStorage.setItem("snd",allowSound)}}function setMarks(enabled,skipSave){if(enabled==true){allowMarks=true;$("#game_mrk").addClass("checked")}else{allowMarks=false;$("#game_mrk").removeClass("checked")}if(!skipSave){localStorage.setItem("mrk",allowMarks)}}function setColor(enabled,skipSave){if(enabled==true){allowColor=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{allowColor=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!skipSave){localStorage.setItem("clr",allowColor)}}function setDifficulty(diff,skipSave){if(diff<0||diff>3){return}if(diff!=3){customWidth=9;customHeight=9;customMines=10;customSet=false}var lvl=["beg","int","exp","cst"];for(var i=0;i<lvl.length;i++){var element=$("#game_"+lvl[i]);if(i==diff){element.addClass("checked")}else{element.removeClass("checked")}}if(!skipSave){localStorage.setItem("lvl",diff)}initGame(diff)}function setCustomBoard(width,height,mines,skipSave){if(!/^\d*$/.test(width)){width=9}width=width>30?30:width;width=width<9?9:width;if(!/^\d*$/.test(height)){height=9}height=height>24?24:height;height=height<9?9:height;if(!/^\d*$/.test(mines)){mines=10}mines=mines<10?10:mines;var minesAllowed=(height-1)*(width-1);mines=mines>minesAllowed?minesAllowed:mines;customSet=true;customWidth=width;customHeight=height;customMines=mines;if(!skipSave){localStorage.setItem("board_width",width);localStorage.setItem("board_height",height);localStorage.setItem("board_mines",mines)}}function rebindEvents(){$(".window *").off("contextmenu").on("contextmenu",function(e){e.preventDefault()});$(".ms-panel").off("mousedown").on("mousedown",function(e){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!gameOver){switch(e.which){case 1:tileActive=true;$(this).trigger("mouseenter");break;case 2:groupActive=true;$(this).trigger("mouseenter");break;case 3:var target=$(this);handlePanelClick(target,e);break}}});$(".ms-panel").off("mouseenter").on("mouseenter",function(e){if(tileActive&&!$(this).hasClass("flagged")){$(this).addClass("down")}else if(groupActive){var coords=getCoords($(this));var tileRange=getTileRange(coords[0],coords[1]);for(var i=tileRange[0][0];i<=tileRange[0][1];i++){for(var j=tileRange[1][0];j<=tileRange[1][1];j++){if(!isFlagged(i,j)){$('.ms-panel[data-coord="'+i+","+j+'"]').addClass("down")}}}}});$(".ms-panel").off("mouseleave").on("mouseleave",function(e){if((tileActive||groupActive)&&(e.which==1||e.which==2)){$(".ms-panel.down").removeClass("down")}});$(".ms-panel").off("mouseup").on("mouseup",function(e){if((tileActive||groupActive)&&!gameOver){if(gameWaiting){startGame()}var target=$(this);handlePanelClick(target,e)}})}function handlePanelClick(target,ev){if(!target.length||!target.hasClass("ms-panel")){return}var coord=getCoords(target);var row=coord[0];var col=coord[1];if(ev.which==1){$(".smiley-icon").removeClass("active");tileActive=false;if(!gameOver){if(!isTriggered(row,col)){trigger(row,col)}}}if(ev.which==2&&isNumber(row,col)&&isTriggered(row,col)){var tileRange=getTileRange(row,col);var triggerQueue=[];var flagsLeft=getNumber(row,col);for(var i=tileRange[0][0];i<=tileRange[0][1];i++){for(var j=tileRange[1][0];j<=tileRange[1][1];j++){if(i==row&&j==col){continue}if(isFlagged(i,j)){flagsLeft--}else{triggerQueue.push([i,j])}}}if(flagsLeft!==0){return}var tilesInQueue=triggerQueue.length;for(var i=0;i<tilesInQueue;i++){var qRow=triggerQueue[i][0];var qCol=triggerQueue[i][1];if(isMine(qRow,qCol)){triggerQueue.splice(i,1);triggerQueue.push([qRow,qCol]);tilesInQueue--;i--}}for(var i=0;i<triggerQueue.length;i++){var qRow=triggerQueue[i][0];var qCol=triggerQueue[i][1];trigger(qRow,qCol)}}else if(ev.which==3){if(!gameOver&&!isTriggered(row,col)){if(!isFlagged(row,col)&&!isMarked(row,col)){flag(row,col);subMine()}else if(allowMarks&&isFlagged(row,col)){mark(row,col);addMine()}else{if(!allowMarks){addMine()}clear(row,col)}}}}function getCoords(target){var coords=target.data("coord").split(",");return[parseInt(coords[0],10),parseInt(coords[1],10)]}function flag(row,col){var tile=tiles[row][col];if(!gameOver&&!tile.triggered&&!tile.marked){tiles[row][col].flagged=true}rerender(row,col)}function mark(row,col){var tile=tiles[row][col];if(!gameOver&&!tile.triggered&&tile.flagged){tile.flagged=false;tile.marked=true}tiles[row][col]=tile;rerender(row,col)}function clear(row,col){var tile=tiles[row][col];if(!gameOver&&!tile.triggered){tile.marked=false;tile.flagged=false}tiles[row][col]=tile;rerender(row,col)}function trigger(row,col){var tile=tiles[row][col];if(gameOver||tile.triggered||tile.flagged){return}tile.triggered=true;tiles[row][col]=tile;if(!noMoves&&tile.isMine){explode(row,col);return}else if(noMoves&&tile.isMine){tiles[row][col].isMine=false;setNumbers(row,col,true);placeMine(row,col)}rerender(row,col);if(tile.number==0&&!tile.isMine&&!tile.flagged){cascadeTrigger(row,col)}if(--tilesLeft==0){winGame()}noMoves=false}function cascadeTrigger(row,col){var rowMinBound=row==0?0:row-1;var rowMaxBound=row==boardHeight-1?boardHeight-1:row+1;var colMinBound=col==0?0:col-1;var colMaxBound=col==boardWidth-1?boardWidth-1:col+1;for(var i=rowMinBound;i<=rowMaxBound;i++){for(var j=colMinBound;j<=colMaxBound;j++){var tile=tiles[i][j];if(tile.number>0||!tile.isMine&&!tile.flagged){trigger(i,j)}}}}function mine(i,j){tiles[i][j].isMine=true}function explode(i,j){var tile=tiles[i][j];if(!tile.isMine){return}tile.exploded=true;tiles[i][j]=tile;if(allowSound){document.getElementById("snd_explode").play()}endGame();for(var i=0;i<boardHeight;i++){for(var j=0;j<boardWidth;j++){var tileToTrigger=tiles[i][j];var mustRender=false;if(!tileToTrigger.flagged&&tileToTrigger.isMine){mustRender=true}else if(!tileToTrigger.isMine&&tileToTrigger.flagged){mustRender=true;tileToTrigger.number=0}if(mustRender){tileToTrigger.triggered=true;tiles[i][j]=tileToTrigger;rerender(i,j)}}}$(".smiley-icon").addClass("dead")}function isTriggered(i,j){return tiles[i][j].triggered}function isClear(i,j){var tile=tiles[i][j];return!tile.triggered&&!tile.marked&&!tile.flagged}function isNumber(i,j){return tiles[i][j].number!=0}function isMarked(i,j){return tiles[i][j].marked}function isFlagged(i,j){return tiles[i][j].flagged}function isMine(i,j){return tiles[i][j].isMine}function getNumber(i,j){return tiles[i][j].number}function rerender(i,j){var target=$('.ms-panel[data-coord="'+i+","+j+'"]');var tile=tiles[i][j];target.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(tile.triggered){target.addClass("triggered");if(tile.number>0){target.addClass("m"+tile.number)}if(tile.isMine){target.addClass("mine")}if(tile.exploded){target.addClass("exploded")}if(!tile.isMine&&tile.flagged){target.addClass("bogus")}}else{if(tile.flagged){target.addClass("flagged")}if(tile.marked){target.addClass("marked")}}}function timeStart(){timeTick();timer=setInterval(function(){timeTick()},1e3)}function timeStop(){clearInterval(timer)}function timeTick(){if(time<999){time++;digitRender("time",time);if(allowSound){document.getElementById("snd_tick").play()}}}function addMine(){if(minesLeft<maxMines){minesLeft++;digitRender("mines",minesLeft)}}function subMine(){if(minesLeft>-99){minesLeft--;digitRender("mines",minesLeft>-100?minesLeft:-99)}}function digitRender(target,number){target=".num-box#"+target;num=Math.abs(number);var hundreds=Math.floor(num/100);num-=hundreds*100;var tens=Math.floor(num/10);num-=tens*10;if(number<0){hundreds="n"}$(target+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(target+" .digit.iii").addClass("d"+hundreds);$(target+" .digit.ii").addClass("d"+tens);$(target+" .digit.i").addClass("d"+num)}function initGame(diff){endGame();gameWaiting=true;gameOver=false;noMoves=true;if(diff<0||diff>3||diff==3&&!customSet){diff=0}var defaults={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};if(diff!=3){var width=defaults.width[diff];var height=defaults.height[diff];var mines=defaults.mines[diff]}else{var width=customWidth;var height=customHeight;var mines=customMines}maxMines=mines;minesLeft=mines;boardWidth=width;boardHeight=height;difficulty=diff;exploded=false;time=0;tiles=[];tilesLeft=width*height-mines;if(firstGame){firstGame=false;var top=localStorage.getItem("leaderboard");var leaders=leaderboard;try{if(top!=null){leaders=$.parseJSON(top)}}catch(e){console.log("Error: leaderboard data is corrupt. Resetting to default...");localStorage.setItem("leaderboard",JSON.stringify(leaderboard))}for(var leaderLvl=0;leaderLvl<3;leaderLvl++){updateLeaderboard(leaderLvl,leaders[leaderLvl][0],leaders[leaderLvl][1],true)}var sndPref=localStorage.getItem("snd");sndPref=sndPref=="true"?true:false;setSound(sndPref,true);var mrkPref=localStorage.getItem("mrk");mrkPref=mrkPref=="true"||mrkPref==null?true:false;setMarks(mrkPref,true);var clrPref=localStorage.getItem("clr");clrPref=clrPref=="true"||clrPref==null?true:false;setColor(clrPref,true);var lvlPref=localStorage.getItem("lvl");var bwPref=localStorage.getItem("board_width");var bhPref=localStorage.getItem("board_height");var bmPref=localStorage.getItem("board_mines");if(lvlPref!==null){if(lvlPref!=3||bwPref!==null&&bhPref!=null&&bmPref!=null){if(lvlPref==3){setCustomBoard(bwPref,bhPref,bmPref,true)}setDifficulty(lvlPref,true);return}}}generateGrid();digitRender("time",time);digitRender("mines",minesLeft);$(".smiley-icon").removeClass("active cool dead");rebindEvents();env.showWindow($("#ms-main"),40,40)}function generateGrid(){var grid="";for(var i=0;i<boardHeight;i++){tiles.push([]);grid+="<div class='ms-row'>";for(var j=0;j<boardWidth;j++){tiles[i].push(new Tile);grid+="<div class='ms-panel' data-coord='"+i+","+j+"'></div>"}grid+="</div>"}var mineNum=maxMines;while(mineNum--){placeMine()}$(".ms-grid").html(grid)}function placeMine(exclRow,exclCol){var excl=typeof exclRow!="undefined";var row=-1;var col=-1;var tile=null;do{row=getRandomNumber(0,boardHeight-1);col=getRandomNumber(0,boardWidth-1);tile=tiles[row][col]}while(tile.isMine||excl&&row==exclRow&&col==exclCol);tiles[row][col].number=0;mine(row,col);setNumbers(row,col)}function setNumbers(row,col,recalc){var tileRange=getTileRange(row,col);var adjMines=0;for(var i=tileRange[0][0];i<=tileRange[0][1];i++){for(var j=tileRange[1][0];j<=tileRange[1][1];j++){if(isMine(i,j)){adjMines++;continue}if(row==i&&col==j){continue}if(!recalc){tiles[i][j].number++}else{tiles[i][j].number--}}}if(recalc){tiles[row][col].number=adjMines}}function getRandomNumber(min,max){return Math.floor(Math.random()*(max+1-min))+min}function getTileRange(row,col){var rowMinBound=row==0?0:row-1;var rowMaxBound=row==boardHeight-1?boardHeight-1:row+1;var colMinBound=col==0?0:col-1;var colMaxBound=col==boardWidth-1?boardWidth-1:col+1;return[[rowMinBound,rowMaxBound],[colMinBound,colMaxBound]]}function isGameRunning(){return!gameWaiting&&!gameOver}function startGame(){if(gameWaiting){gameWaiting=false;gameOver=false;timeStart()}}function endGame(){gameOver=true;timeStop()}function winGame(){$(".smiley-icon").addClass("cool");if(allowSound){document.getElementById("snd_win").play()}if(difficulty<3&&difficulty>=0){if(leaderboard[difficulty][1]>time){var levelNames=["beginner","intermediate","expert"];var highScoreMsgContainer=$("#ms-high-score #hs-description");var highScoreMsg=highScoreMsgContainer.data("hs-msg").replace("%LEVEL%",levelNames[difficulty]);highScoreMsgContainer.html(highScoreMsg);$("#ms-high-score #hs-name").val(leaderboard[difficulty][0]);var containerOffset=$(".minesweeper").offset();var statusOffset=$(".ms-status").offset().top+$(".ms-status").outerHeight();env.showWindow($("#ms-high-score"),containerOffset.left,statusOffset,$("#ms-main"));$("#ms-high-score #hs-name").select()}}endGame()}function updateLeaderboard(difficulty,name,time,skipSave){if(difficulty<0||difficulty>2||time<0||time>999){return}name=name.substr(0,32);leaderboard[difficulty][0]=name;leaderboard[difficulty][1]=time;if(!skipSave){localStorage.setItem("leaderboard",JSON.stringify(leaderboard))}var row=$("#ms-leaderboard .leader-container .row[data-leader-row="+difficulty+"]");var timeText=$("#ms-leaderboard .leader-container").data("time-string").replace("%TIME%",time);row.find(".time").first().html(timeText);row.find(".name").first().html(name)}function resetLeaderboard(){for(var lvl=0;lvl<2;lvl++){updateLeaderboard(lvl,"Anonymous",999)}}})();
