(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var B=window.SweeperOSEnvironment;var I=null;var R=0;var p=true;var A=true;var F=true;var g=false;var Z=false;var o=0;var c=0;var K=0;var t=0;var E=0;var P=null;var am=0;var L=false;var k=false;var S=true;var u=false;var y=true;var aq=false;var az=9;var W=9;var at=10;var h=true;var q=false;var v=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function ak(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(aB){$(".smiley-icon").removeClass("active");L=false;k=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(aB){if($(".window#ms-main").hasClass("focused")){if(aB.which==113){aB.preventDefault();H(K)}else{if(aB.which==112){aB.preventDefault();J()}else{if(aB.which==27){if(q){p=false}}}}return}if($(".window#ms-custom-board").hasClass("focused")){if(aB.which==27){ai()}else{if(aB.which==13){if($(".cst-form input").is(":focus")){x()}else{$("#ms-custom-board .btns .btn-container.active").click()}}}return}if($(".window#ms-high-score").hasClass("focused")){if(aB.which==27||aB.which==13){w()}return}if($(".window#ms-leaderboard").hasClass("focused")){if(aB.which==27){U()}else{if(aB.which==13){$(this).find("#ms-leaderboard .btns .btn-container.active").click()}}return}if($(".window#ms-about").hasClass("focused")){if(aB.which==27||aB.which==13){O()}return}if($(".window#ms-help").hasClass("focused")){if(aB.which==27||aB.which==13){z()}return}});$(".minesweeper").off("mousedown").on("mousedown",function(aB){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g&&(aB.which==1||aB.which==2)){$(".smiley-icon").addClass("active")}});$(".smiley-btn").off("click").on("click",function(aB){H(K)});$("#game_new").on("click",function(aB){H(K)});$("#game_beg:not(.disabled)").on("click",function(aB){ax(0)});$("#game_int:not(.disabled)").on("click",function(aB){ax(1)});$("#game_exp:not(.disabled)").on("click",function(aB){ax(2)});$("#game_cst:not(.disabled)").on("click",function(aC){var aB=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(W);$("#ms-custom-board #cst-width").val(az);$("#ms-custom-board #cst-mines").val(at);B.showWindow($("#ms-custom-board"),aB.left,aB.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(aB){r(!S)});$("#game_snd:not(.disabled)").on("click",function(aB){au(!u)});$("#game_clr:not(.disabled)").on("click",function(aB){d(!y)});$("#game_ldr:not(.disabled)").on("click",function(aB){Y()});$("#help_abt:not(.disabled)").on("click",function(aB){ab()});$("#help_play:not(.disabled)").on("click",function(aB){J()});$("#cst_ok").on("click",x);$("#cst_cancel").on("click",ai);$("#hs_ok").on("click",w);$("#leader_ok").on("click",U);$("#leader_reset").on("click",N);$("#about_ok").on("click",O);$("#help_ok").on("click",z);H(0)});function x(){var aD=$("#cst-width").val();var aC=$("#cst-height").val();var aB=$("#cst-mines").val();f(aD,aC,aB);ax(3);B.closeWindow($("#ms-custom-board"))}function ai(){H(K);B.closeWindow($("#ms-custom-board"))}function w(){aj(K,$("#ms-high-score #hs-name").val(),R);B.closeWindow($("#ms-high-score"));Y()}function U(){B.closeWindow($("#ms-leaderboard"))}function Y(){var aC=$(".minesweeper").offset();var aB=$(".ms-status").offset().top+$(".ms-status").outerHeight();B.showWindow($("#ms-leaderboard"),aC.left,aB,$("#ms-main"))}function ab(){var aB=$(".minesweeper").offset();B.showWindow($("#ms-about"),aB.left+30,aB.top+33,$("#ms-main"))}function O(){B.closeWindow($("#ms-about"))}function J(){var aB=$(".minesweeper").offset();B.showWindow($("#ms-help"),aB.left+30,aB.top+33,$("#ms-main"))}function z(){$("#ms-help .help-content-inner").scrollTop(0);B.closeWindow($("#ms-help"))}function au(aB,aC){if(aB==true){u=true;$("#game_snd").addClass("checked")}else{u=false;$("#game_snd").removeClass("checked")}if(!aC){localStorage.setItem("snd",u)}}function r(aB,aC){if(aB==true){S=true;$("#game_mrk").addClass("checked")}else{S=false;$("#game_mrk").removeClass("checked")}if(!aC){localStorage.setItem("mrk",S)}}function d(aB,aC){if(aB==true){y=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{y=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!aC){localStorage.setItem("clr",y)}}function ax(aF,aE){if(aF<0||aF>3){return}if(aF!=3){az=9;W=9;at=10;aq=false}var aB=["beg","int","exp","cst"];for(var aD=0;aD<aB.length;aD++){var aC=$("#game_"+aB[aD]);if(aD==aF){aC.addClass("checked")}else{aC.removeClass("checked")}}if(!aE){localStorage.setItem("lvl",aF)}H(aF)}function f(aE,aB,aF,aD){if(!/^\d*$/.test(aE)){aE=9}aE=(aE>30?30:aE);aE=(aE<9?9:aE);if(!/^\d*$/.test(aB)){aB=9}aB=(aB>24?24:aB);aB=(aB<9?9:aB);if(!/^\d*$/.test(aF)){aF=10}aF=(aF<10?10:aF);var aC=(aB-1)*(aE-1);aF=(aF>aC?aC:aF);aq=true;az=aE;W=aB;at=aF;if(!aD){localStorage.setItem("board_width",aE);localStorage.setItem("board_height",aB);localStorage.setItem("board_mines",aF)}}function aw(){$(".window *").off("contextmenu").on("contextmenu",function(aB){aB.preventDefault()});$(".minesweeper").off("mousedown").on("mousedown",function(aB){if(aB.which==2){q=true}});$(".minesweeper").off("mouseup").on("mouseup",function(aB){q=false});$(".minesweeper .ms-panel").off("mousedown").on("mousedown",function(aC){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g){switch(aC.which){case 1:L=true;$(this).trigger("mouseenter");break;case 2:k=true;$(this).trigger("mouseenter");break;case 3:var aB=$(this);b(aB,aC);break}}});$(".minesweeper .ms-panel").off("mouseenter").on("mouseenter",function(aF){if(L&&!$(this).hasClass("flagged")){$(this).addClass("down")}else{if(k){var aE=ac($(this));var aD=j(aE[0],aE[1]);for(var aC=aD[0][0];aC<=aD[0][1];aC++){for(var aB=aD[1][0];aB<=aD[1][1];aB++){if(!M(aC,aB)){$('.ms-panel[data-coord="'+aC+","+aB+'"]').addClass("down")}}}}}});$(".minesweeper .ms-panel").off("mouseleave").on("mouseleave",function(aB){if((L||k)&&(aB.which==1||aB.which==2)){$(".ms-panel.down").removeClass("down")}});$(".minesweeper .ms-panel").off("mouseup").on("mouseup",function(aC){if((L||k)&&!g){if(A){n()}var aB=$(this);b(aB,aC)}})}function b(aK,aL){if(!aK.length||!aK.hasClass("ms-panel")){return}var aI=ac(aK);var aN=aI[0];var aC=aI[1];if(aL.which==1){$(".smiley-icon").removeClass("active");L=false;if(!g){if(!ao(aN,aC)){ag(aN,aC)}}}if(aL.which==2&&G(aN,aC)&&ao(aN,aC)){var aB=j(aN,aC);var aD=[];var aJ=X(aN,aC);for(var aG=aB[0][0];aG<=aB[0][1];aG++){for(var aF=aB[1][0];aF<=aB[1][1];aF++){if(aG==aN&&aF==aC){continue}if(M(aG,aF)){aJ--}else{aD.push([aG,aF])}}}if(aJ!==0){return}var aE=aD.length;for(var aG=0;aG<aE;aG++){var aH=aD[aG][0];var aM=aD[aG][1];if(e(aH,aM)){aD.splice(aG,1);aD.push([aH,aM]);aE--;aG--}}for(var aG=0;aG<aD.length;aG++){var aH=aD[aG][0];var aM=aD[aG][1];ag(aH,aM)}}else{if(aL.which==3){if(!g&&!ao(aN,aC)){if(!M(aN,aC)&&!av(aN,aC)){aA(aN,aC);T()}else{if(S&&M(aN,aC)){af(aN,aC);ah()}else{if(!S){ah()}aa(aN,aC)}}}}}}function ac(aC){var aB=aC.data("coord").split(",");return[parseInt(aB[0],10),parseInt(aB[1],10)]}function aA(aD,aB){var aC=P[aD][aB];if(!g&&!aC.triggered&&!aC.marked){P[aD][aB].flagged=true}ad(aD,aB)}function af(aD,aB){var aC=P[aD][aB];if(!g&&!aC.triggered&&aC.flagged){aC.flagged=false;aC.marked=true}P[aD][aB]=aC;ad(aD,aB)}function aa(aD,aB){var aC=P[aD][aB];if(!g&&!aC.triggered){aC.marked=false;aC.flagged=false}P[aD][aB]=aC;ad(aD,aB)}function ag(aD,aB){var aC=P[aD][aB];if(g||aC.triggered||aC.flagged){return}aC.triggered=true;P[aD][aB]=aC;if(!F&&aC.isMine){l(aD,aB);return}else{if(F&&aC.isMine){P[aD][aB].isMine=false;C(aD,aB,true);D(aD,aB)}}ad(aD,aB);if(aC.number==0&&!aC.isMine&&!aC.flagged){ay(aD,aB)}if(--am==0){a()}F=false}function ay(aJ,aC){var aB=(aJ==0)?0:aJ-1;var aI=(aJ==E-1)?E-1:aJ+1;var aG=(aC==0)?0:aC-1;var aD=(aC==t-1)?t-1:aC+1;for(var aF=aB;aF<=aI;aF++){for(var aE=aG;aE<=aD;aE++){var aH=P[aF][aE];if(aH.number>0||(!aH.isMine&&!aH.flagged)){ag(aF,aE)}}}}function m(aC,aB){P[aC][aB].isMine=true}function l(aC,aB){var aE=P[aC][aB];if(!aE.isMine){return}aE.exploded=true;P[aC][aB]=aE;if(u){document.getElementById("snd_explode").play()}al();for(var aC=0;aC<E;aC++){for(var aB=0;aB<t;aB++){var aD=P[aC][aB];var aF=false;if(!aD.flagged&&aD.isMine){aF=true}else{if(!aD.isMine&&aD.flagged){aF=true;aD.number=0}}if(aF){aD.triggered=true;P[aC][aB]=aD;ad(aC,aB)}}}$(".smiley-icon").addClass("dead")}function ao(aC,aB){return P[aC][aB].triggered}function ar(aC,aB){var aD=P[aC][aB];return !aD.triggered&&!aD.marked&&!aD.flagged}function G(aC,aB){return P[aC][aB].number!=0}function av(aC,aB){return P[aC][aB].marked}function M(aC,aB){return P[aC][aB].flagged}function e(aC,aB){return P[aC][aB].isMine}function X(aC,aB){return P[aC][aB].number}function ad(aC,aB){var aE=$('.ms-panel[data-coord="'+aC+","+aB+'"]');var aD=P[aC][aB];aE.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(aD.triggered){aE.addClass("triggered");if(aD.number>0){aE.addClass("m"+aD.number)}if(aD.isMine){aE.addClass("mine")}if(aD.exploded){aE.addClass("exploded")}if(!aD.isMine&&aD.flagged){aE.addClass("bogus")}}else{if(aD.flagged){aE.addClass("flagged")}if(aD.marked){aE.addClass("marked")}}}function an(){V();I=setInterval(function(){V()},1000)}function s(){clearInterval(I)}function V(){if(p){if(R<999){R++;i("time",R);if(u){document.getElementById("snd_tick").play()}}}}function ah(){if(o<c){o++;i("mines",o)}}function T(){if(o>-99){o--;i("mines",(o>-100)?o:-99)}}function i(aE,aD){aE=".num-box#"+aE;num=Math.abs(aD);var aC=Math.floor(num/100);num-=aC*100;var aB=Math.floor(num/10);num-=aB*10;if(aD<0){aC="n"}$(aE+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(aE+" .digit.iii").addClass("d"+aC);$(aE+" .digit.ii").addClass("d"+aB);$(aE+" .digit.i").addClass("d"+num)}function H(aM){al();A=true;g=false;F=true;if(aM<0||aM>3||(aM==3&&!aq)){aM=0}var aG={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};if(aM!=3){var aE=aG.width[aM];var aP=aG.height[aM];var aO=aG.mines[aM]}else{var aE=az;var aP=W;var aO=at}c=aO;o=aO;t=aE;E=aP;K=aM;Z=false;R=0;P=[];am=(aE*aP)-aO;if(h){h=false;var aK=localStorage.getItem("leaderboard");var aI=v;try{if(aK!=null){aI=$.parseJSON(aK)}}catch(aJ){console.log("Error: leaderboard data is corrupt. Resetting to default...");localStorage.setItem("leaderboard",JSON.stringify(v))}for(var aD=0;aD<3;aD++){aj(aD,aI[aD][0],aI[aD][1],true)}var aN=localStorage.getItem("snd");aN=(aN=="true")?true:false;au(aN,true);var aC=localStorage.getItem("mrk");aC=(aC=="true"||aC==null)?true:false;r(aC,true);var aF=localStorage.getItem("clr");aF=(aF=="true"||aF==null)?true:false;d(aF,true);var aL=localStorage.getItem("lvl");var aB=localStorage.getItem("board_width");var aH=localStorage.getItem("board_height");var aQ=localStorage.getItem("board_mines");if(aL!==null){if(aL!=3||(aB!==null&&aH!=null&&aQ!=null)){if(aL==3){f(aB,aH,aQ,true)}ax(aL,true);return}}}ae();i("time",R);i("mines",o);$(".smiley-icon").removeClass("active cool dead");aw();B.showWindow($("#ms-main"),40,40)}function ae(){var aE="";for(var aD=0;aD<E;aD++){P.push([]);aE+="<div class='ms-row'>";for(var aC=0;aC<t;aC++){P[aD].push(new ak());aE+="<div class='ms-panel' data-coord='"+aD+","+aC+"'></div>"}aE+="</div>"}var aB=c;while(aB--){D()}$(".ms-grid").html(aE)}function D(aC,aE){var aG=typeof aC!="undefined";var aF=-1;var aB=-1;var aD=null;do{aF=ap(0,E-1);aB=ap(0,t-1);aD=P[aF][aB]}while(aD.isMine||(aG&&aF==aC&&aB==aE));P[aF][aB].number=0;m(aF,aB);C(aF,aB)}function C(aH,aE,aC){var aG=j(aH,aE);var aB=0;for(var aF=aG[0][0];aF<=aG[0][1];aF++){for(var aD=aG[1][0];aD<=aG[1][1];aD++){if(e(aF,aD)){aB++;continue}if((aH==aF&&aE==aD)){continue}if(!aC){P[aF][aD].number++}else{P[aF][aD].number--}}}if(aC){P[aH][aE].number=aB}}function ap(aC,aB){return Math.floor(Math.random()*(aB+1-aC))+aC}function j(aF,aD){var aE=(aF==0)?0:aF-1;var aG=(aF==E-1)?E-1:aF+1;var aB=(aD==0)?0:aD-1;var aC=(aD==t-1)?t-1:aD+1;return[[aE,aG],[aB,aC]]}function Q(){return !A&&!g}function n(){if(A){A=false;g=false;an()}}function al(){g=true;s()}function a(){$(".smiley-icon").addClass("cool");if(u){document.getElementById("snd_win").play()}if(K<3&&K>=0){if(v[K][1]>R){var aD=["beginner","intermediate","expert"];var aB=$("#ms-high-score #hs-description");var aF=aB.data("hs-msg").replace("%LEVEL%",aD[K]);aB.html(aF);$("#ms-high-score #hs-name").val(v[K][0]);var aE=$(".minesweeper").offset();var aC=$(".ms-status").offset().top+$(".ms-status").outerHeight();B.showWindow($("#ms-high-score"),aE.left,aC,$("#ms-main"));$("#ms-high-score #hs-name").select()}}al()}function aj(aC,aD,aF,aE){if(aC<0||aC>2||aF<0||aF>999){return}aD=aD.substr(0,32);v[aC][0]=aD;v[aC][1]=aF;if(!aE){localStorage.setItem("leaderboard",JSON.stringify(v))}var aG=$("#ms-leaderboard .leader-container .row[data-leader-row="+aC+"]");var aB=$("#ms-leaderboard .leader-container").data("time-string").replace("%TIME%",aF);aG.find(".time").first().html(aB);aG.find(".name").first().html(aD)}function N(){for(var aB=0;aB<2;aB++){aj(aB,"Anonymous",999)}}})();