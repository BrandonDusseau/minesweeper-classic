(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var D=window.SweeperOSEnvironment;var K=null;var S=0;var q=true;var C=true;var H=true;var g=false;var p=0;var c=0;var M=0;var u=0;var G=0;var R=null;var ao=0;var N=false;var j=false;var U=true;var w=false;var A=true;var au=false;var aB=9;var Y=9;var av=10;var h=true;var r=false;var T=false;var ad=0;var x=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function am(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(){$(".smiley-icon").removeClass("active");N=false;j=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(aD){if($(".window#ms-main").hasClass("focused")){if(aD.which==113){aD.preventDefault();J(M)}else{if(aD.which==112){aD.preventDefault();L()}else{if(aD.which==27){if(r){q=false}}}}if(!T){if((aD.which==88&&ad)==0||(aD.which==89&&(ad==1||ad==4)||(aD.which==90&&(ad==2||ad==3)))){ad++}else{if(aD.which==16&&ad==5){$("#pixel").css("display","block");T=true}else{ad=0}}}return}if($(".window#ms-custom-board").hasClass("focused")){if(aD.which==27){ak()}else{if(aD.which==13){if($(".cst-form input").is(":focus")){z()}else{$("#ms-custom-board .btns .btn-container.active").click()}}}return}if($(".window#ms-high-score").hasClass("focused")){if(aD.which==27||aD.which==13){y()}return}if($(".window#ms-leaderboard").hasClass("focused")){if(aD.which==27){W()}else{if(aD.which==13){$(this).find("#ms-leaderboard .btns .btn-container.active").click()}}return}if($(".window#ms-about").hasClass("focused")){if(aD.which==27||aD.which==13){Q()}return}if($(".window#ms-help").hasClass("focused")){if(aD.which==27||aD.which==13){B()}return}});$(".minesweeper").off("mousedown").on("mousedown",function(aD){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g&&(aD.which==1||aD.which==2)){$(".smiley-icon").addClass("active")}if(aD.which==2){r=true}});$(".minesweeper").off("mouseup").on("mouseup",function(){r=false});$(".smiley-btn").off("click").on("click",function(){J(M)});$("#game_new").on("click",function(){J(M)});$("#game_beg:not(.disabled)").on("click",function(){az(0)});$("#game_int:not(.disabled)").on("click",function(){az(1)});$("#game_exp:not(.disabled)").on("click",function(){az(2)});$("#game_cst:not(.disabled)").on("click",function(){var aD=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(Y);$("#ms-custom-board #cst-width").val(aB);$("#ms-custom-board #cst-mines").val(av);D.showWindow($("#ms-custom-board"),aD.left,aD.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(){s(!U)});$("#game_snd:not(.disabled)").on("click",function(){aw(!w)});$("#game_clr:not(.disabled)").on("click",function(){d(!A)});$("#game_ldr:not(.disabled)").on("click",function(){aa()});$("#help_abt:not(.disabled)").on("click",function(){ac()});$("#help_play:not(.disabled)").on("click",function(){L()});$("#cst_ok").on("click",z);$("#cst_cancel").on("click",ak);$("#hs_ok").on("click",y);$("#leader_ok").on("click",W);$("#leader_reset").on("click",P);$("#about_ok").on("click",Q);$("#help_ok").on("click",B);aq()});function ay(){$(".window *").off("contextmenu").on("contextmenu",function(aD){aD.preventDefault()});$(".minesweeper .ms-panel").off("mousedown").on("mousedown",function(aE){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g){switch(aE.which){case 1:N=true;$(this).trigger("mouseenter");break;case 2:j=true;$(this).trigger("mouseenter");break;case 3:var aD=$(this);b(aD,aE);break;default:break}}});$(".minesweeper .ms-panel").off("mouseenter").on("mouseenter",function(){var aG=ae($(this));if(N&&!$(this).hasClass("flagged")){$(this).addClass("down")}else{if(j){var aF=k(aG[0],aG[1]);for(var aE=aF[0][0];aE<=aF[0][1];aE++){for(var aD=aF[1][0];aD<=aF[1][1];aD++){if(!O(aE,aD)){$('.ms-panel[data-coord="'+aE+","+aD+'"]').addClass("down")}}}}}if(T){if(e(aG[0],aG[1])){$("#pixel").css("background-color","#000")}else{$("#pixel").css("background-color","#FFF")}}});$(".minesweeper .ms-panel").off("mouseleave").on("mouseleave",function(aD){if((N||j)&&(aD.which==1||aD.which==2)){$(".ms-panel.down").removeClass("down")}});$(".minesweeper .ms-panel").off("mouseup").on("mouseup",function(aE){if((N||j)&&!g){if(C){o()}var aD=$(this);b(aD,aE)}})}function aq(){$("body").addClass("loading");var aD=["about_header.gif","sprite.gif","spritebw.gif","bw_bg.gif","cursor_default.gif","cursor_pointer.gif"];var aF=[];var aG=function(aH,aJ){var aI=new Image();aI.onload=function(){aJ.resolve()};aI.src=aH};for(var aE=0;aE<aD.length;aE++){aF[aE]=$.Deferred();aG("img/"+aD[aE],aF[aE])}$.when.apply($,aF).done(function(){$("body").removeClass("loading");J(0)})}function z(){var aF=$("#cst-width").val();var aE=$("#cst-height").val();var aD=$("#cst-mines").val();f(aF,aE,aD);az(3);D.closeWindow($("#ms-custom-board"))}function ak(){J(M);D.closeWindow($("#ms-custom-board"))}function y(){al(M,$("#ms-high-score #hs-name").val(),S);D.closeWindow($("#ms-high-score"));aa()}function W(){D.closeWindow($("#ms-leaderboard"))}function aa(){var aE=$(".minesweeper").offset();var aD=$(".ms-status").offset().top+$(".ms-status").outerHeight();D.showWindow($("#ms-leaderboard"),aE.left,aD,$("#ms-main"))}function ac(){var aD=$(".minesweeper").offset();D.showWindow($("#ms-about"),aD.left+30,aD.top+33,$("#ms-main"))}function Q(){D.closeWindow($("#ms-about"))}function L(){var aD=$(".minesweeper").offset();D.showWindow($("#ms-help"),aD.left+30,aD.top+33,$("#ms-main"))}function B(){$("#ms-help .help-content-inner").scrollTop(0);D.closeWindow($("#ms-help"))}function aw(aD,aE){if(aD==true){w=true;$("#game_snd").addClass("checked")}else{w=false;$("#game_snd").removeClass("checked")}if(!aE){l("snd",w)}}function s(aD,aE){if(aD==true){U=true;$("#game_mrk").addClass("checked")}else{U=false;$("#game_mrk").removeClass("checked")}if(!aE){l("mrk",U)}}function d(aD,aE){if(aD==true){A=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{A=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!aE){l("clr",A)}}function az(aH,aF){if(aH<0||aH>3){return}if(aH!=3){aB=9;Y=9;av=10;au=false}var aD=["beg","int","exp","cst"];for(var aG=0;aG<aD.length;aG++){var aE=$("#game_"+aD[aG]);if(aG==aH){aE.addClass("checked")}else{aE.removeClass("checked")}}if(!aF){l("lvl",aH)}J(aH)}function f(aG,aD,aH,aF){if(!/^\d*$/.test(aG)){aG=9}aG=(aG>30?30:aG);aG=(aG<9?9:aG);if(!/^\d*$/.test(aD)){aD=9}aD=(aD>24?24:aD);aD=(aD<9?9:aD);if(!/^\d*$/.test(aH)){aH=10}aH=(aH<10?10:aH);var aE=(aD-1)*(aG-1);aH=(aH>aE?aE:aH);au=true;aB=aG;Y=aD;av=aH;if(!aF){l("board_width",aG);l("board_height",aD);l("board_mines",aH)}}function b(aN,aO){if(!aN.length||!aN.hasClass("ms-panel")){return}var aJ=ae(aN);var aT=aJ[0];var aF=aJ[1];if(aO.which==1){$(".smiley-icon").removeClass("active");N=false;if(!g){if(!ar(aT,aF)){ai(aT,aF)}}}if(aO.which==2&&I(aT,aF)&&ar(aT,aF)){var aE=k(aT,aF);var aG=[];var aM=Z(aT,aF);for(var aR=aE[0][0];aR<=aE[0][1];aR++){for(var aD=aE[1][0];aD<=aE[1][1];aD++){if(aR==aT&&aD==aF){continue}if(O(aR,aD)){aM--}else{aG.push([aR,aD])}}}if(aM!=0){return}var aH=aG.length;for(var aI=0;aI<aH;aI++){var aP=aG[aI][0];var aS=aG[aI][1];if(e(aP,aS)){aG.splice(aI,1);aG.push([aP,aS]);aH--;aI--}}for(var aL=0;aL<aG.length;aL++){var aK=aG[aL][0];var aQ=aG[aL][1];ai(aK,aQ)}}else{if(aO.which==3){if(!g&&!ar(aT,aF)){if(!O(aT,aF)&&!ax(aT,aF)){aC(aT,aF);V()}else{if(U&&O(aT,aF)){ah(aT,aF);aj()}else{if(!U){aj()}ab(aT,aF)}}}}}}function ae(aE){var aD=aE.data("coord").split(",");return[parseInt(aD[0],10),parseInt(aD[1],10)]}function aC(aF,aD){var aE=R[aF][aD];if(!g&&!aE.triggered&&!aE.marked){R[aF][aD].flagged=true}af(aF,aD)}function ah(aF,aD){var aE=R[aF][aD];if(!g&&!aE.triggered&&aE.flagged){aE.flagged=false;aE.marked=true}R[aF][aD]=aE;af(aF,aD)}function ab(aF,aD){var aE=R[aF][aD];if(!g&&!aE.triggered){aE.marked=false;aE.flagged=false}R[aF][aD]=aE;af(aF,aD)}function n(aE,aD){R[aE][aD].isMine=true}function ar(aE,aD){return R[aE][aD].triggered}function I(aE,aD){return R[aE][aD].number!=0}function ax(aE,aD){return R[aE][aD].marked}function O(aE,aD){return R[aE][aD].flagged}function e(aE,aD){return R[aE][aD].isMine}function Z(aE,aD){return R[aE][aD].number}function aj(){if(p<c){p++;i("mines",p)}}function V(){if(p>-99){p--;i("mines",(p>-100)?p:-99)}}function ai(aF,aD){var aE=R[aF][aD];if(g||aE.triggered||aE.flagged){return}aE.triggered=true;R[aF][aD]=aE;if(!H&&aE.isMine){m(aF,aD);return}else{if(H&&aE.isMine){R[aF][aD].isMine=false;E(aF,aD,true);F(aF,aD)}}af(aF,aD);if(aE.number==0&&!aE.isMine&&!aE.flagged){aA(aF,aD)}if(--ao==0){a()}H=false}function aA(aL,aF){var aE=(aL==0)?0:aL-1;var aK=(aL==G-1)?G-1:aL+1;var aH=(aF==0)?0:aF-1;var aG=(aF==u-1)?u-1:aF+1;for(var aJ=aE;aJ<=aK;aJ++){for(var aD=aH;aD<=aG;aD++){var aI=R[aJ][aD];if(aI.number>0||(!aI.isMine&&!aI.flagged)){ai(aJ,aD)}}}}function m(aI,aE){var aG=R[aI][aE];if(!aG.isMine){return}aG.exploded=true;R[aI][aE]=aG;if(w){document.getElementById("snd_explode").play()}an();for(var aD=0;aD<G;aD++){for(var aH=0;aH<u;aH++){var aF=R[aD][aH];var aJ=false;if(!aF.flagged&&aF.isMine){aJ=true}else{if(!aF.isMine&&aF.flagged){aJ=true;aF.number=0}}if(aJ){aF.triggered=true;R[aD][aH]=aF;af(aD,aH)}}}$(".smiley-icon").addClass("dead")}function af(aG,aD){var aF=$('.ms-panel[data-coord="'+aG+","+aD+'"]');var aE=R[aG][aD];aF.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(aE.triggered){aF.addClass("triggered");if(aE.number>0){aF.addClass("m"+aE.number)}if(aE.isMine){aF.addClass("mine")}if(aE.exploded){aF.addClass("exploded")}if(!aE.isMine&&aE.flagged){aF.addClass("bogus")}}else{if(aE.flagged){aF.addClass("flagged")}if(aE.marked){aF.addClass("marked")}}}function i(aH,aG){aH=".num-box#"+aH;var aF=Math.abs(aG);var aE=Math.floor(aF/100);aF-=aE*100;var aD=Math.floor(aF/10);aF-=aD*10;if(aG<0){aE="n"}$(aH+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(aH+" .digit.iii").addClass("d"+aE);$(aH+" .digit.ii").addClass("d"+aD);$(aH+" .digit.i").addClass("d"+aF)}function J(aO){an();C=true;g=false;H=true;q=true;if(aO<0||aO>3||(aO==3&&!au)){aO=0}var aI={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};var aG,aR,aQ;if(aO!=3){aG=aI.width[aO];aR=aI.height[aO];aQ=aI.mines[aO]}else{aG=aB;aR=Y;aQ=av}c=aQ;p=aQ;u=aG;G=aR;M=aO;S=0;R=[];ao=(aG*aR)-aQ;if(h){h=false;var aM=v("leaderboard");var aK=x;try{if(aM!=null){aK=$.parseJSON(aM)}}catch(aL){console.log("Error: leaderboard data is corrupt. Resetting to default...");l("leaderboard",JSON.stringify(x))}for(var aF=0;aF<3;aF++){al(aF,aK[aF][0],aK[aF][1],true)}var aP=v("snd");aP=(aP=="true")?true:false;aw(aP,true);var aE=v("mrk");aE=(aE=="true"||aE==null)?true:false;s(aE,true);var aH=v("clr");aH=(aH=="true"||aH==null)?true:false;d(aH,true);var aN=v("lvl");var aD=v("board_width");var aJ=v("board_height");var aS=v("board_mines");if(aN!=null){if(aN!=3||(aD!=null&&aJ!=null&&aS!=null)){if(aN==3){f(aD,aJ,aS,true)}az(aN,true);return}}}ag();i("time",S);i("mines",p);$(".smiley-icon").removeClass("active cool dead");ay();D.showWindow($("#ms-main"),40,40)}function ag(){var aF="";for(var aG=0;aG<G;aG++){R.push([]);aF+="<div class='ms-row'>";for(var aE=0;aE<u;aE++){R[aG].push(new am());aF+="<div class='ms-panel' data-coord='"+aG+","+aE+"'></div>"}aF+="</div>"}var aD=c;while(aD--){F()}$(".ms-grid").html(aF)}function F(aE,aG){var aI=typeof aE!="undefined";var aH=-1;var aD=-1;var aF=null;do{aH=at(0,G-1);aD=at(0,u-1);aF=R[aH][aD]}while(aF.isMine||(aI&&aH==aE&&aD==aG));R[aH][aD].number=0;n(aH,aD);E(aH,aD)}function E(aJ,aG,aE){var aI=k(aJ,aG);var aD=0;for(var aH=aI[0][0];aH<=aI[0][1];aH++){for(var aF=aI[1][0];aF<=aI[1][1];aF++){if(e(aH,aF)){aD++;continue}if((aJ==aH&&aG==aF)){continue}if(!aE){R[aH][aF].number++}else{R[aH][aF].number--}}}if(aE){R[aJ][aG].number=aD}}function at(aE,aD){return Math.floor(Math.random()*(aD+1-aE))+aE}function k(aH,aF){var aG=(aH==0)?0:aH-1;var aI=(aH==G-1)?G-1:aH+1;var aD=(aF==0)?0:aF-1;var aE=(aF==u-1)?u-1:aF+1;return[[aG,aI],[aD,aE]]}function o(){if(C){C=false;g=false;ap()}}function an(){g=true;t()}function a(){$(".smiley-icon").addClass("cool");if(w){document.getElementById("snd_win").play()}if(M<3&&M>=0){if(x[M][1]>S){var aF=["beginner","intermediate","expert"];var aD=$("#ms-high-score #hs-description");var aH=aD.data("hs-msg").replace("%LEVEL%",aF[M]);aD.html(aH);$("#ms-high-score #hs-name").val(x[M][0]);var aG=$(".minesweeper").offset();var aE=$(".ms-status").offset().top+$(".ms-status").outerHeight();D.showWindow($("#ms-high-score"),aG.left,aE,$("#ms-main"));$("#ms-high-score #hs-name").select()}}an()}function ap(){X();K=setInterval(function(){X()},1000)}function t(){clearInterval(K)}function X(){if(q){if(S<999){S++;i("time",S);if(w){document.getElementById("snd_tick").play()}}}}function al(aI,aF,aE,aG){if(aI<0||aI>2||aE<0||aE>999){return}aF=aF.substr(0,32);x[aI][0]=aF;x[aI][1]=aE;if(!aG){l("leaderboard",JSON.stringify(x))}var aH=$("#ms-leaderboard .leader-container .row[data-leader-row="+aI+"]");var aD=$("#ms-leaderboard .leader-container").data("time-string").replace("%TIME%",aE);aH.find(".time").first().html(aD);aH.find(".name").first().html(aF)}function P(){for(var aD=0;aD<2;aD++){al(aD,"Anonymous",999)}}function v(aD){if(typeof window.localStorage!="undefined"){return window.localStorage.getItem(aD)}return null}function l(aD,aE){if(typeof window.localStorage!="undefined"){window.localStorage.setItem(aD,aE)}}})();