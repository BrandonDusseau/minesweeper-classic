(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var y=window.SweeperOSEnvironment;var F=null;var M=0;var x=true;var C=true;var g=false;var U=false;var o=0;var c=0;var G=0;var r=0;var B=0;var K=null;var ag=0;var H=false;var j=false;var N=true;var s=false;var w=true;var ak=false;var at=9;var R=9;var am=10;var h=true;var t=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function ae(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(av){$(".smiley-icon").removeClass("active");H=false;j=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(av){if($(".window#ms-main").hasClass("focused")){if(av.which==113){av.preventDefault();E(G)}else{if(av.which==112){av.preventDefault()}}}if($(".window#ms-custom-board").hasClass("focused")){if(av.which==27){ac()}else{if(av.which==13){if($("#cst-form input").is(":focus")){v()}else{$(this).find(".btn-container.active").first().click()}}}}if($(".window#ms-high-score").hasClass("focused")){if(av.which==27||av.which==13){u()}}if($(".window#ms-high-score").hasClass("focused")){if(av.which==27){P()}else{if(av.which==13){$(this).find(".btn-container.active").first().click()}}}});$(".minesweeper").off("mousedown").on("mousedown",function(av){if(!g&&(av.which==1||av.which==2)){$(".smiley-icon").addClass("active")}});$(".smiley-btn").off("click").on("click",function(av){E(G)});$("#game_new").on("click",function(av){E(G)});$("#game_beg:not(.disabled)").on("click",function(av){aq(0)});$("#game_int:not(.disabled)").on("click",function(av){aq(1)});$("#game_exp:not(.disabled)").on("click",function(av){aq(2)});$("#game_cst:not(.disabled)").on("click",function(aw){var av=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(R);$("#ms-custom-board #cst-width").val(at);$("#ms-custom-board #cst-mines").val(am);y.showWindow($("#ms-custom-board"),av.left,av.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(av){p(!N)});$("#game_snd:not(.disabled)").on("click",function(av){an(!s)});$("#game_clr:not(.disabled)").on("click",function(av){d(!w)});$("#game_ldr:not(.disabled)").on("click",function(av){T()});$("#cst_ok").on("click",v);$("#cst_cancel").on("click",ac);$("#hs_ok").on("click",u);$("#leader_ok").on("click",P);$("#leader_reset").on("click",J);E(0)});function v(){var ax=$("#cst-width").val();var aw=$("#cst-height").val();var av=$("#cst-mines").val();f(ax,aw,av);aq(3);y.closeWindow($("#ms-custom-board"))}function ac(){E(G);y.closeWindow($("#ms-custom-board"))}function u(){ad(G,$("#ms-high-score #hs-name").val(),M);y.closeWindow($("#ms-high-score"));T()}function P(){y.closeWindow($("#ms-leaderboard"))}function T(){var aw=$(".minesweeper").offset();var av=$(".ms-status").offset().top+$(".ms-status").outerHeight();y.showWindow($("#ms-leaderboard"),aw.left,av,$("#ms-main"))}function an(av,aw){if(av==true){s=true;$("#game_snd").addClass("checked")}else{s=false;$("#game_snd").removeClass("checked")}if(!aw){localStorage.setItem("snd",s)}}function p(av,aw){if(av==true){N=true;$("#game_mrk").addClass("checked")}else{N=false;$("#game_mrk").removeClass("checked")}if(!aw){localStorage.setItem("mrk",N)}}function d(av,aw){if(av==true){w=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{w=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!aw){localStorage.setItem("clr",w)}}function aq(az,ay){if(az<0||az>3){return}if(az!=3){at=9;R=9;am=10;ak=false}var av=["beg","int","exp","cst"];for(var ax=0;ax<av.length;ax++){var aw=$("#game_"+av[ax]);if(ax==az){aw.addClass("checked")}else{aw.removeClass("checked")}}if(!ay){localStorage.setItem("lvl",az)}E(az)}function f(ay,av,az,ax){if(!/^\d*$/.test(ay)){ay=9}ay=(ay>30?30:ay);ay=(ay<9?9:ay);if(!/^\d*$/.test(av)){av=9}av=(av>24?24:av);av=(av<9?9:av);if(!/^\d*$/.test(az)){az=10}az=(az<10?10:az);var aw=(av-1)*(ay-1);az=(az>aw?aw:az);ak=true;at=ay;R=av;am=az;if(!ax){localStorage.setItem("board_width",ay);localStorage.setItem("board_height",av);localStorage.setItem("board_mines",az)}}function ap(){$(".window *").off("contextmenu").on("contextmenu",function(av){av.preventDefault()});$(".ms-panel").off("mousedown").on("mousedown",function(aw){if(!g){switch(aw.which){case 1:H=true;$(this).trigger("mouseenter");break;case 2:j=true;$(this).trigger("mouseenter");break;case 3:var av=$(this);b(av,aw);break}}});$(".ms-panel").off("mouseenter").on("mouseenter",function(az){if(H&&!$(this).hasClass("flagged")){$(this).addClass("down")}else{if(j){var ay=W($(this));var ax=k(ay[0],ay[1]);for(var aw=ax[0][0];aw<=ax[0][1];aw++){for(var av=ax[1][0];av<=ax[1][1];av++){if(!I(aw,av)){$('.ms-panel[data-coord="'+aw+","+av+'"]').addClass("down")}}}}}});$(".ms-panel").off("mouseleave").on("mouseleave",function(av){if((H||j)&&(av.which==1||av.which==2)){$(".ms-panel.down").removeClass("down")}});$(".ms-panel").off("mouseup").on("mouseup",function(aw){if((H||j)&&!g){if(x){n()}var av=$(this);b(av,aw)}})}function b(aE,aF){if(!aE.length||!aE.hasClass("ms-panel")){return}var aC=W(aE);var aH=aC[0];var aw=aC[1];if(aF.which==1){$(".smiley-icon").removeClass("active");H=false;if(!g){if(!ai(aH,aw)){aa(aH,aw)}}}if(aF.which==2&&D(aH,aw)&&ai(aH,aw)){var av=k(aH,aw);var ax=[];var aD=S(aH,aw);for(var aA=av[0][0];aA<=av[0][1];aA++){for(var az=av[1][0];az<=av[1][1];az++){if(aA==aH&&az==aw){continue}if(I(aA,az)){aD--}else{ax.push([aA,az])}}}if(aD!==0){return}var ay=ax.length;for(var aA=0;aA<ay;aA++){var aB=ax[aA][0];var aG=ax[aA][1];if(e(aB,aG)){ax.splice(aA,1);ax.push([aB,aG]);ay--;aA--}}for(var aA=0;aA<ax.length;aA++){var aB=ax[aA][0];var aG=ax[aA][1];aa(aB,aG)}}else{if(aF.which==3){if(!g&&!ai(aH,aw)){if(!I(aH,aw)&&!ao(aH,aw)){au(aH,aw);O()}else{if(N&&I(aH,aw)){Z(aH,aw);ab()}else{if(!N){ab()}V(aH,aw)}}}}}}function W(aw){var av=aw.data("coord").split(",");return[parseInt(av[0],10),parseInt(av[1],10)]}function au(ax,av){var aw=K[ax][av];if(!g&&!aw.triggered&&!aw.marked){K[ax][av].flagged=true}X(ax,av)}function Z(ax,av){var aw=K[ax][av];if(!g&&!aw.triggered&&aw.flagged){aw.flagged=false;aw.marked=true}K[ax][av]=aw;X(ax,av)}function V(ax,av){var aw=K[ax][av];if(!g&&!aw.triggered){aw.marked=false;aw.flagged=false}K[ax][av]=aw;X(ax,av)}function aa(ax,av){var aw=K[ax][av];if(g||aw.triggered||aw.flagged){return}aw.triggered=true;K[ax][av]=aw;if(!C&&aw.isMine){l(ax,av);return}else{if(C&&aw.isMine){K[ax][av].isMine=false;z(ax,av,true);A(ax,av)}}X(ax,av);if(aw.number==0&&!aw.isMine&&!aw.flagged){ar(ax,av)}if(--ag==0){a()}C=false}function ar(aD,aw){var av=(aD==0)?0:aD-1;var aC=(aD==B-1)?B-1:aD+1;var aA=(aw==0)?0:aw-1;var ax=(aw==r-1)?r-1:aw+1;for(var az=av;az<=aC;az++){for(var ay=aA;ay<=ax;ay++){var aB=K[az][ay];if(aB.number>0||(!aB.isMine&&!aB.flagged)){aa(az,ay)}}}}function m(aw,av){K[aw][av].isMine=true}function l(aw,av){var ay=K[aw][av];if(!ay.isMine){return}ay.exploded=true;K[aw][av]=ay;if(s){document.getElementById("snd_explode").play()}af();for(var aw=0;aw<B;aw++){for(var av=0;av<r;av++){var ax=K[aw][av];var az=false;if(!ax.flagged&&ax.isMine){az=true}else{if(!ax.isMine&&ax.flagged){az=true;ax.number=0}}if(az){ax.triggered=true;K[aw][av]=ax;X(aw,av)}}}$(".smiley-icon").addClass("dead")}function ai(aw,av){return K[aw][av].triggered}function al(aw,av){var ax=K[aw][av];return !ax.triggered&&!ax.marked&&!ax.flagged}function D(aw,av){return K[aw][av].number!=0}function ao(aw,av){return K[aw][av].marked}function I(aw,av){return K[aw][av].flagged}function e(aw,av){return K[aw][av].isMine}function S(aw,av){return K[aw][av].number}function X(aw,av){var ay=$('.ms-panel[data-coord="'+aw+","+av+'"]');var ax=K[aw][av];ay.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(ax.triggered){ay.addClass("triggered");if(ax.number>0){ay.addClass("m"+ax.number)}if(ax.isMine){ay.addClass("mine")}if(ax.exploded){ay.addClass("exploded")}if(!ax.isMine&&ax.flagged){ay.addClass("bogus")}}else{if(ax.flagged){ay.addClass("flagged")}if(ax.marked){ay.addClass("marked")}}}function ah(){Q();F=setInterval(function(){Q()},1000)}function q(){clearInterval(F)}function Q(){if(M<999){M++;i("time",M);if(s){document.getElementById("snd_tick").play()}}}function ab(){if(o<c){o++;i("mines",o)}}function O(){if(o>-99){o--;i("mines",(o>-100)?o:-99)}}function i(ay,ax){ay=".num-box#"+ay;num=Math.abs(ax);var aw=Math.floor(num/100);num-=aw*100;var av=Math.floor(num/10);num-=av*10;if(ax<0){aw="n"}$(ay+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(ay+" .digit.iii").addClass("d"+aw);$(ay+" .digit.ii").addClass("d"+av);$(ay+" .digit.i").addClass("d"+num)}function E(aG){af();x=true;g=false;C=true;if(aG<0||aG>3||(aG==3&&!ak)){aG=0}var aA={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};if(aG!=3){var ay=aA.width[aG];var aJ=aA.height[aG];var aI=aA.mines[aG]}else{var ay=at;var aJ=R;var aI=am}c=aI;o=aI;r=ay;B=aJ;G=aG;U=false;M=0;K=[];ag=(ay*aJ)-aI;if(h){h=false;var aE=localStorage.getItem("leaderboard");var aC=t;try{if(aE!=null){aC=$.parseJSON(aE)}}catch(aD){console.log("Error: leaderboard data is corrupt. Resetting to default...");localStorage.setItem("leaderboard",JSON.stringify(t))}for(var ax=0;ax<3;ax++){console.log(aC[ax]);ad(ax,aC[ax][0],aC[ax][1],true)}var aH=localStorage.getItem("snd");aH=(aH=="true"||aH==null)?true:false;an(aH,true);var aw=localStorage.getItem("mrk");aw=(aw=="true"||aw==null)?true:false;p(aw,true);var az=localStorage.getItem("clr");az=(az=="true"||az==null)?true:false;d(az,true);var aF=localStorage.getItem("lvl");var av=localStorage.getItem("board_width");var aB=localStorage.getItem("board_height");var aK=localStorage.getItem("board_mines");if(aF!==null){if(aF!=3||(av!==null&&aB!=null&&aK!=null)){if(aF==3){f(av,aB,aK,true)}aq(aF,true);return}}}Y();i("time",M);i("mines",o);$(".smiley-icon").removeClass("active cool dead");ap();y.showWindow($("#ms-main"),40,40)}function Y(){var ay="";for(var ax=0;ax<B;ax++){K.push([]);ay+="<div class='ms-row'>";for(var aw=0;aw<r;aw++){K[ax].push(new ae());ay+="<div class='ms-panel' data-coord='"+ax+","+aw+"'></div>"}ay+="</div>"}var av=c;while(av--){A()}$(".ms-grid").html(ay)}function A(aw,ay){var aA=typeof aw!="undefined";var az=-1;var av=-1;var ax=null;do{az=aj(0,B-1);av=aj(0,r-1);ax=K[az][av]}while(ax.isMine||(aA&&az==aw&&av==ay));K[az][av].number=0;m(az,av);z(az,av)}function z(aB,ay,aw){var aA=k(aB,ay);var av=0;for(var az=aA[0][0];az<=aA[0][1];az++){for(var ax=aA[1][0];ax<=aA[1][1];ax++){if(e(az,ax)){av++;continue}if((aB==az&&ay==ax)){continue}if(!aw){K[az][ax].number++}else{K[az][ax].number--}}}if(aw){K[aB][ay].number=av}}function aj(aw,av){return Math.floor(Math.random()*(av+1-aw))+aw}function k(az,ax){var ay=(az==0)?0:az-1;var aA=(az==B-1)?B-1:az+1;var av=(ax==0)?0:ax-1;var aw=(ax==r-1)?r-1:ax+1;return[[ay,aA],[av,aw]]}function L(){return !x&&!g}function n(){if(x){x=false;g=false;ah()}}function af(){g=true;q()}function a(){$(".smiley-icon").addClass("cool");if(s){document.getElementById("snd_win").play()}if(G<3&&G>=0){if(t[G][1]>M){var ax=["beginner","intermediate","expert"];var av=$("#ms-high-score #hs-description");var az=av.data("hs-msg").replace("%LEVEL%",ax[G]);av.html(az);$("#ms-high-score #hs-name").val(t[G][0]);var ay=$(".minesweeper").offset();var aw=$(".ms-status").offset().top+$(".ms-status").outerHeight();y.showWindow($("#ms-high-score"),ay.left,aw,$("#ms-main"));$("#ms-high-score #hs-name").select()}}af()}function ad(aw,ax,az,ay){if(aw<0||aw>2||az<0||az>999){return}ax=ax.substr(0,32);t[aw][0]=ax;t[aw][1]=az;if(!ay){localStorage.setItem("leaderboard",JSON.stringify(t))}var aA=$("#ms-leaderboard .leader-container .row[data-leader-row="+aw+"]");var av=$("#ms-leaderboard .leader-container").data("time-string").replace("%TIME%",az);console.log(av);console.log(aA.find(".time"));aA.find(".time").first().html(av);aA.find(".name").first().html(ax)}function J(){for(var av=0;av<2;av++){ad(av,"Anonymous",999)}}})();