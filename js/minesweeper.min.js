(function(){if(typeof window.SweeperOSEnvironment=="undefined"){console.log("Sweeper OS envrionment is unavailable. Minesweeper cannot run.");return}var D=window.SweeperOSEnvironment;var K=null;var T=0;var q=true;var C=true;var H=true;var g=false;var ad=false;var p=0;var c=0;var M=0;var u=0;var G=0;var R=null;var ar=0;var N=false;var k=false;var V=true;var w=false;var A=true;var aw=false;var aE=9;var aa=9;var ay=10;var h=true;var r=false;var U=false;var ag=0;var x=[["Anonymous",999],["Anonymous",999],["Anonymous",999]];function ap(){this.number=0;this.isMine=false;this.flagged=false;this.marked=false;this.triggered=false;this.exploded=false}$(document).ready(function(){$("body").on("mouseup",function(aG){$(".smiley-icon").removeClass("active");N=false;k=false;$(".ms-panel.down").removeClass("down")});$("body").on("keydown",function(aG){if($(".window#ms-main").hasClass("focused")){if(aG.which==113){aG.preventDefault();J(M)}else{if(aG.which==112){aG.preventDefault();L()}else{if(aG.which==27){if(r){q=false}}}}if(!U){if(aG.which==88&&ag==0){ag++}else{if(aG.which==89&&(ag==1||ag==4)){ag++}else{if(aG.which==90&&(ag==2||ag==3)){ag++}else{if(aG.which==16&&ag==5){$("#pixel").css("display","block");U=true}else{ag=0}}}}}return}if($(".window#ms-custom-board").hasClass("focused")){if(aG.which==27){an()}else{if(aG.which==13){if($(".cst-form input").is(":focus")){z()}else{$("#ms-custom-board .btns .btn-container.active").click()}}}return}if($(".window#ms-high-score").hasClass("focused")){if(aG.which==27||aG.which==13){y()}return}if($(".window#ms-leaderboard").hasClass("focused")){if(aG.which==27){Y()}else{if(aG.which==13){$(this).find("#ms-leaderboard .btns .btn-container.active").click()}}return}if($(".window#ms-about").hasClass("focused")){if(aG.which==27||aG.which==13){Q()}return}if($(".window#ms-help").hasClass("focused")){if(aG.which==27||aG.which==13){B()}return}});$(".minesweeper").off("mousedown").on("mousedown",function(aG){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g&&(aG.which==1||aG.which==2)){$(".smiley-icon").addClass("active")}if(aG.which==2){r=true}});$(".minesweeper").off("mouseup").on("mouseup",function(aG){r=false});$(".smiley-btn").off("click").on("click",function(aG){J(M)});$("#game_new").on("click",function(aG){J(M)});$("#game_beg:not(.disabled)").on("click",function(aG){aC(0)});$("#game_int:not(.disabled)").on("click",function(aG){aC(1)});$("#game_exp:not(.disabled)").on("click",function(aG){aC(2)});$("#game_cst:not(.disabled)").on("click",function(aH){var aG=$(".minesweeper").offset();$("#ms-custom-board #cst-height").val(aa);$("#ms-custom-board #cst-width").val(aE);$("#ms-custom-board #cst-mines").val(ay);D.showWindow($("#ms-custom-board"),aG.left,aG.top,$("#ms-main"))});$("#game_mrk:not(.disabled)").on("click",function(aG){s(!V)});$("#game_snd:not(.disabled)").on("click",function(aG){az(!w)});$("#game_clr:not(.disabled)").on("click",function(aG){d(!A)});$("#game_ldr:not(.disabled)").on("click",function(aG){ac()});$("#help_abt:not(.disabled)").on("click",function(aG){af()});$("#help_play:not(.disabled)").on("click",function(aG){L()});$("#cst_ok").on("click",z);$("#cst_cancel").on("click",an);$("#hs_ok").on("click",y);$("#leader_ok").on("click",Y);$("#leader_reset").on("click",P);$("#about_ok").on("click",Q);$("#help_ok").on("click",B);X()});function X(){$("body").addClass("loading");var aJ=["about_header.gif","sprite.gif","spritebw.gif","bw_bg.gif","cursor_default.gif","cursor_pointer.gif"];var aH=[];var aI=function(aK,aM){var aL=new Image();aL.onload=function(){aM.resolve()};aL.src=aK};for(var aG=0;aG<aJ.length;aG++){aH[aG]=$.Deferred();aI("img/"+aJ[aG],aH[aG])}$.when.apply($,aH).done(function(){$("body").removeClass("loading");J(0)})}function z(){var aI=$("#cst-width").val();var aH=$("#cst-height").val();var aG=$("#cst-mines").val();f(aI,aH,aG);aC(3);D.closeWindow($("#ms-custom-board"))}function an(){J(M);D.closeWindow($("#ms-custom-board"))}function y(){ao(M,$("#ms-high-score #hs-name").val(),T);D.closeWindow($("#ms-high-score"));ac()}function Y(){D.closeWindow($("#ms-leaderboard"))}function ac(){var aH=$(".minesweeper").offset();var aG=$(".ms-status").offset().top+$(".ms-status").outerHeight();D.showWindow($("#ms-leaderboard"),aH.left,aG,$("#ms-main"))}function af(){var aG=$(".minesweeper").offset();D.showWindow($("#ms-about"),aG.left+30,aG.top+33,$("#ms-main"))}function Q(){D.closeWindow($("#ms-about"))}function L(){var aG=$(".minesweeper").offset();D.showWindow($("#ms-help"),aG.left+30,aG.top+33,$("#ms-main"))}function B(){$("#ms-help .help-content-inner").scrollTop(0);D.closeWindow($("#ms-help"))}function az(aG,aH){if(aG==true){w=true;$("#game_snd").addClass("checked")}else{w=false;$("#game_snd").removeClass("checked")}if(!aH){l("snd",w)}}function s(aG,aH){if(aG==true){V=true;$("#game_mrk").addClass("checked")}else{V=false;$("#game_mrk").removeClass("checked")}if(!aH){l("mrk",V)}}function d(aG,aH){if(aG==true){A=true;$("#game_clr").addClass("checked");$(".minesweeper").removeClass("no-color")}else{A=false;$("#game_clr").removeClass("checked");$(".minesweeper").addClass("no-color")}if(!aH){l("clr",A)}}function aC(aK,aJ){if(aK<0||aK>3){return}if(aK!=3){aE=9;aa=9;ay=10;aw=false}var aG=["beg","int","exp","cst"];for(var aI=0;aI<aG.length;aI++){var aH=$("#game_"+aG[aI]);if(aI==aK){aH.addClass("checked")}else{aH.removeClass("checked")}}if(!aJ){l("lvl",aK)}J(aK)}function f(aJ,aG,aK,aI){if(!/^\d*$/.test(aJ)){aJ=9}aJ=(aJ>30?30:aJ);aJ=(aJ<9?9:aJ);if(!/^\d*$/.test(aG)){aG=9}aG=(aG>24?24:aG);aG=(aG<9?9:aG);if(!/^\d*$/.test(aK)){aK=10}aK=(aK<10?10:aK);var aH=(aG-1)*(aJ-1);aK=(aK>aH?aH:aK);aw=true;aE=aJ;aa=aG;ay=aK;if(!aI){l("board_width",aJ);l("board_height",aG);l("board_mines",aK)}}function aB(){$(".window *").off("contextmenu").on("contextmenu",function(aG){aG.preventDefault()});$(".minesweeper .ms-panel").off("mousedown").on("mousedown",function(aH){if($(this).closest(".window").hasClass("modal-frozen")){return}if(!g){switch(aH.which){case 1:N=true;$(this).trigger("mouseenter");break;case 2:k=true;$(this).trigger("mouseenter");break;case 3:var aG=$(this);b(aG,aH);break}}});$(".minesweeper .ms-panel").off("mouseenter").on("mouseenter",function(aK){if(N&&!$(this).hasClass("flagged")){$(this).addClass("down")}else{if(k){var aJ=ah($(this));var aI=j(aJ[0],aJ[1]);for(var aH=aI[0][0];aH<=aI[0][1];aH++){for(var aG=aI[1][0];aG<=aI[1][1];aG++){if(!O(aH,aG)){$('.ms-panel[data-coord="'+aH+","+aG+'"]').addClass("down")}}}}}if(U){var aJ=ah($(this));if(e(aJ[0],aJ[1])){$("#pixel").css("background-color","#000")}else{$("#pixel").css("background-color","#FFF")}}});$(".minesweeper .ms-panel").off("mouseleave").on("mouseleave",function(aG){if((N||k)&&(aG.which==1||aG.which==2)){$(".ms-panel.down").removeClass("down")}});$(".minesweeper .ms-panel").off("mouseup").on("mouseup",function(aH){if((N||k)&&!g){if(C){o()}var aG=$(this);b(aG,aH)}})}function b(aP,aQ){if(!aP.length||!aP.hasClass("ms-panel")){return}var aN=ah(aP);var aS=aN[0];var aH=aN[1];if(aQ.which==1){$(".smiley-icon").removeClass("active");N=false;if(!g){if(!au(aS,aH)){al(aS,aH)}}}if(aQ.which==2&&I(aS,aH)&&au(aS,aH)){var aG=j(aS,aH);var aI=[];var aO=ab(aS,aH);for(var aL=aG[0][0];aL<=aG[0][1];aL++){for(var aK=aG[1][0];aK<=aG[1][1];aK++){if(aL==aS&&aK==aH){continue}if(O(aL,aK)){aO--}else{aI.push([aL,aK])}}}if(aO!==0){return}var aJ=aI.length;for(var aL=0;aL<aJ;aL++){var aM=aI[aL][0];var aR=aI[aL][1];if(e(aM,aR)){aI.splice(aL,1);aI.push([aM,aR]);aJ--;aL--}}for(var aL=0;aL<aI.length;aL++){var aM=aI[aL][0];var aR=aI[aL][1];al(aM,aR)}}else{if(aQ.which==3){if(!g&&!au(aS,aH)){if(!O(aS,aH)&&!aA(aS,aH)){aF(aS,aH);W()}else{if(V&&O(aS,aH)){ak(aS,aH);am()}else{if(!V){am()}ae(aS,aH)}}}}}}function ah(aH){var aG=aH.data("coord").split(",");return[parseInt(aG[0],10),parseInt(aG[1],10)]}function aF(aI,aG){var aH=R[aI][aG];if(!g&&!aH.triggered&&!aH.marked){R[aI][aG].flagged=true}ai(aI,aG)}function ak(aI,aG){var aH=R[aI][aG];if(!g&&!aH.triggered&&aH.flagged){aH.flagged=false;aH.marked=true}R[aI][aG]=aH;ai(aI,aG)}function ae(aI,aG){var aH=R[aI][aG];if(!g&&!aH.triggered){aH.marked=false;aH.flagged=false}R[aI][aG]=aH;ai(aI,aG)}function al(aI,aG){var aH=R[aI][aG];if(g||aH.triggered||aH.flagged){return}aH.triggered=true;R[aI][aG]=aH;if(!H&&aH.isMine){m(aI,aG);return}else{if(H&&aH.isMine){R[aI][aG].isMine=false;E(aI,aG,true);F(aI,aG)}}ai(aI,aG);if(aH.number==0&&!aH.isMine&&!aH.flagged){aD(aI,aG)}if(--ar==0){a()}H=false}function aD(aO,aH){var aG=(aO==0)?0:aO-1;var aN=(aO==G-1)?G-1:aO+1;var aL=(aH==0)?0:aH-1;var aI=(aH==u-1)?u-1:aH+1;for(var aK=aG;aK<=aN;aK++){for(var aJ=aL;aJ<=aI;aJ++){var aM=R[aK][aJ];if(aM.number>0||(!aM.isMine&&!aM.flagged)){al(aK,aJ)}}}}function n(aH,aG){R[aH][aG].isMine=true}function m(aH,aG){var aJ=R[aH][aG];if(!aJ.isMine){return}aJ.exploded=true;R[aH][aG]=aJ;if(w){document.getElementById("snd_explode").play()}aq();for(var aH=0;aH<G;aH++){for(var aG=0;aG<u;aG++){var aI=R[aH][aG];var aK=false;if(!aI.flagged&&aI.isMine){aK=true}else{if(!aI.isMine&&aI.flagged){aK=true;aI.number=0}}if(aK){aI.triggered=true;R[aH][aG]=aI;ai(aH,aG)}}}$(".smiley-icon").addClass("dead")}function au(aH,aG){return R[aH][aG].triggered}function ax(aH,aG){var aI=R[aH][aG];return !aI.triggered&&!aI.marked&&!aI.flagged}function I(aH,aG){return R[aH][aG].number!=0}function aA(aH,aG){return R[aH][aG].marked}function O(aH,aG){return R[aH][aG].flagged}function e(aH,aG){return R[aH][aG].isMine}function ab(aH,aG){return R[aH][aG].number}function ai(aH,aG){var aJ=$('.ms-panel[data-coord="'+aH+","+aG+'"]');var aI=R[aH][aG];aJ.removeClass("triggered mine exploded m1 m2 m3 m4 m5 m6 m7 m8 flagged marked");if(aI.triggered){aJ.addClass("triggered");if(aI.number>0){aJ.addClass("m"+aI.number)}if(aI.isMine){aJ.addClass("mine")}if(aI.exploded){aJ.addClass("exploded")}if(!aI.isMine&&aI.flagged){aJ.addClass("bogus")}}else{if(aI.flagged){aJ.addClass("flagged")}if(aI.marked){aJ.addClass("marked")}}}function at(){Z();K=setInterval(function(){Z()},1000)}function t(){clearInterval(K)}function Z(){if(q){if(T<999){T++;i("time",T);if(w){document.getElementById("snd_tick").play()}}}}function am(){if(p<c){p++;i("mines",p)}}function W(){if(p>-99){p--;i("mines",(p>-100)?p:-99)}}function i(aJ,aI){aJ=".num-box#"+aJ;num=Math.abs(aI);var aH=Math.floor(num/100);num-=aH*100;var aG=Math.floor(num/10);num-=aG*10;if(aI<0){aH="n"}$(aJ+" .digit").removeClass("d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 dn");$(aJ+" .digit.iii").addClass("d"+aH);$(aJ+" .digit.ii").addClass("d"+aG);$(aJ+" .digit.i").addClass("d"+num)}function J(aR){aq();C=true;g=false;H=true;q=true;if(aR<0||aR>3||(aR==3&&!aw)){aR=0}var aL={width:[9,16,30],height:[9,16,16],mines:[10,40,99]};if(aR!=3){var aJ=aL.width[aR];var aU=aL.height[aR];var aT=aL.mines[aR]}else{var aJ=aE;var aU=aa;var aT=ay}c=aT;p=aT;u=aJ;G=aU;M=aR;ad=false;T=0;R=[];ar=(aJ*aU)-aT;if(h){h=false;var aP=v("leaderboard");var aN=x;try{if(aP!=null){aN=$.parseJSON(aP)}}catch(aO){console.log("Error: leaderboard data is corrupt. Resetting to default...");l("leaderboard",JSON.stringify(x))}for(var aI=0;aI<3;aI++){ao(aI,aN[aI][0],aN[aI][1],true)}var aS=v("snd");aS=(aS=="true")?true:false;az(aS,true);var aH=v("mrk");aH=(aH=="true"||aH==null)?true:false;s(aH,true);var aK=v("clr");aK=(aK=="true"||aK==null)?true:false;d(aK,true);var aQ=v("lvl");var aG=v("board_width");var aM=v("board_height");var aV=v("board_mines");if(aQ!==null){if(aQ!=3||(aG!==null&&aM!=null&&aV!=null)){if(aQ==3){f(aG,aM,aV,true)}aC(aQ,true);return}}}aj();i("time",T);i("mines",p);$(".smiley-icon").removeClass("active cool dead");aB();D.showWindow($("#ms-main"),40,40)}function aj(){var aJ="";for(var aI=0;aI<G;aI++){R.push([]);aJ+="<div class='ms-row'>";for(var aH=0;aH<u;aH++){R[aI].push(new ap());aJ+="<div class='ms-panel' data-coord='"+aI+","+aH+"'></div>"}aJ+="</div>"}var aG=c;while(aG--){F()}$(".ms-grid").html(aJ)}function F(aH,aJ){var aL=typeof aH!="undefined";var aK=-1;var aG=-1;var aI=null;do{aK=av(0,G-1);aG=av(0,u-1);aI=R[aK][aG]}while(aI.isMine||(aL&&aK==aH&&aG==aJ));R[aK][aG].number=0;n(aK,aG);E(aK,aG)}function E(aM,aJ,aH){var aL=j(aM,aJ);var aG=0;for(var aK=aL[0][0];aK<=aL[0][1];aK++){for(var aI=aL[1][0];aI<=aL[1][1];aI++){if(e(aK,aI)){aG++;continue}if((aM==aK&&aJ==aI)){continue}if(!aH){R[aK][aI].number++}else{R[aK][aI].number--}}}if(aH){R[aM][aJ].number=aG}}function av(aH,aG){return Math.floor(Math.random()*(aG+1-aH))+aH}function j(aK,aI){var aJ=(aK==0)?0:aK-1;var aL=(aK==G-1)?G-1:aK+1;var aG=(aI==0)?0:aI-1;var aH=(aI==u-1)?u-1:aI+1;return[[aJ,aL],[aG,aH]]}function S(){return !C&&!g}function o(){if(C){C=false;g=false;at()}}function aq(){g=true;t()}function a(){$(".smiley-icon").addClass("cool");if(w){document.getElementById("snd_win").play()}if(M<3&&M>=0){if(x[M][1]>T){var aI=["beginner","intermediate","expert"];var aG=$("#ms-high-score #hs-description");var aK=aG.data("hs-msg").replace("%LEVEL%",aI[M]);aG.html(aK);$("#ms-high-score #hs-name").val(x[M][0]);var aJ=$(".minesweeper").offset();var aH=$(".ms-status").offset().top+$(".ms-status").outerHeight();D.showWindow($("#ms-high-score"),aJ.left,aH,$("#ms-main"));$("#ms-high-score #hs-name").select()}}aq()}function ao(aH,aI,aK,aJ){if(aH<0||aH>2||aK<0||aK>999){return}aI=aI.substr(0,32);x[aH][0]=aI;x[aH][1]=aK;if(!aJ){l("leaderboard",JSON.stringify(x))}var aL=$("#ms-leaderboard .leader-container .row[data-leader-row="+aH+"]");var aG=$("#ms-leaderboard .leader-container").data("time-string").replace("%TIME%",aK);aL.find(".time").first().html(aG);aL.find(".name").first().html(aI)}function P(){for(var aG=0;aG<2;aG++){ao(aG,"Anonymous",999)}}function v(aG){if(typeof window.localStorage!="undefined"){return window.localStorage.getItem(aG)}return null}function l(aG,aH){if(typeof window.localStorage!="undefined"){window.localStorage.setItem(aG,aH)}}})();